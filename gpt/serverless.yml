service: aws-lambda-control-plane
frameworkVersion: "3"

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'ap-southeast-2'}
  architecture: x86_64

  memorySize: 256
  timeout: 10
  logRetentionInDays: 14

  environment:
    STAGE: ${self:provider.stage}
    REGION: ${self:provider.region}
    STAFF_TABLE: Staff-${self:provider.stage}

    # Secret name the code reads from Secrets Manager
    JWT_SECRET_NAME: ${self:service}-${self:provider.stage}-jwt-secret
    JWT_ISSUER: ${self:service}
    JWT_AUDIENCE: ${self:service}-${self:provider.stage}
    JWT_EXPIRES_IN: 30m
    JWT_KEY_CACHE_MS: "300000"

  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:3000
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Correlation-Id
      allowedMethods:
        - GET
        - POST
        - OPTIONS
      allowCredentials: true

    authorizers:
      jwtAuthorizer:
        type: request
        functionName: authorizer
        identitySource:
          - $request.header.Authorization
        resultTtlInSeconds: 300
        enableSimpleResponses: true

plugins:
  - serverless-esbuild
  - serverless-iam-roles-per-function

package:
  individually: true
  patterns:
    - package.jason

custom:
  esbuild:
    packager: pnpm
    bundle: true
    minify: true
    sourcemap: true
    target: node20
    platform: node
    format: esm
    outputFileExtension: .mjs
    mainFields: ["module", "main"]
    concurrency: 10
    exclude:
      - aws-sdk

functions:
  login:
    handler: api/auth/login.handler
    description: Staff login (returns JWT)
    memorySize: 512
    timeout: 10
    events:
      - httpApi:
          path: /auth/login
          method: post
    iamRoleStatementsName: login-${self:provider.stage}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}/index/*
      - Effect: Allow
        Action:
          - secretsmanager:GetSecretValue
        Resource:
          - arn:aws:secretsmanager:${self:provider.region}:*:secret:${self:service}-${self:provider.stage}-jwt-secret*

  authorizer:
    handler: api/authorizer.handler
    description: HTTP API Request Authorizer (JWT verify + enabled check)
    memorySize: 256
    timeout: 5
    iamRoleStatementsName: auth-${self:provider.stage}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - secretsmanager:GetSecretValue
        Resource:
          - arn:aws:secretsmanager:${self:provider.region}:*:secret:${self:service}-${self:provider.stage}-jwt-secret*
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}

resources:
  Resources:
    StaffTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Staff-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: staff_id
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: staff_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: EmailIndex
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        SSESpecification:
          SSEEnabled: true

    # âœ… NEW: JWT signing secret created & managed by CloudFormation
    JwtSigningSecret:
      Type: AWS::SecretsManager::Secret
      Properties:
        Name: ${self:service}-${self:provider.stage}-jwt-secret
        Description: JWT signing key for auth tokens (HS256)
        GenerateSecretString:
          SecretStringTemplate: "{}"
          GenerateStringKey: "key"
          PasswordLength: 64
          ExcludeCharacters: "\"@/\\"
