service: aws-lambda-control-plane
frameworkVersion: "3"

provider:
  name: aws
  runtime: nodejs24.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'ap-southeast-2'}
  architecture: x86_64

  # Sensible defaults; override per-function where needed
  memorySize: 256
  timeout: 10
  logRetentionInDays: 14

  environment:
    STAGE: ${self:provider.stage}
    REGION: ${self:provider.region}

    STAFF_TABLE: Staff-${self:provider.stage}
    PASSWORD_RESET_TOKENS_TABLE: PasswordResetTokens-${self:provider.stage}
    TENANTS_TABLE: Tenants-${self:provider.stage}

    # Store secret name (or switch to ARN if you prefer)
    JWT_SECRET_NAME: ${self:service}-${self:provider.stage}-jwt-secret

  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:3000
        # Prefer explicit prod domains later (wildcards can be tricky)
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Correlation-Id
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: true

    authorizers:
      jwtAuthorizer:
        type: request
        functionName: authorizer
        identitySource:
          - $request.header.Authorization
        # Cache authorizer result (decision), not the token itself
        resultTtlInSeconds: 300
        enableSimpleResponses: true

  # IMPORTANT: enforce least-privilege by NOT granting broad provider role
  iam:
    role:
      statements: []

plugins:
  - serverless-esbuild
  - serverless-offline
  - serverless-iam-roles-per-function

package:
  patterns:
    - "!node_modules/**"
    - "!**/*.test.*"
    - "!tests/**"
    - "!**/__tests__/**"
    - "!**/.cache/**"
    - "!**/.serverless/**"
    - "api/**"
    - "src/**"
    - "package.json"
    - "pnpm-lock.yaml"

custom:
  esbuild:
    bundle: true
    minify: true
    sourcemap: true
    target: node24
    platform: node
    concurrency: 10
    # AWS provides AWS SDK v2 in runtime; we recommend AWS SDK v3 (bundled).
    # If you use v3 (@aws-sdk/*), do NOT exclude it.
    exclude:
      - aws-sdk

functions:
  # -----------------------
  # Authorizer (JWT verify)
  # -----------------------
  authorizer:
    handler: api/authorizer.handler
    description: JWT verification and role-based access control
    memorySize: 256
    timeout: 5
    environment:
      LOG_LEVEL: INFO
    iamRoleStatements:
      - Effect: Allow
        Action:
          - secretsmanager:GetSecretValue
        Resource:
          - arn:aws:secretsmanager:${self:provider.region}:*:secret:${self:service}-${self:provider.stage}-jwt-secret*
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:GetItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}
          - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}/index/*
      - Effect: Allow
        Action:
          - xray:PutTraceSegments
          - xray:PutTelemetryRecords
        Resource: "*"

  # -----------------------
  # Auth
  # -----------------------
  login:
    handler: api/auth/login.handler
    description: Staff login with JWT generation
    memorySize: 512     # bcrypt/crypto typically needs more CPU
    timeout: 10
    events:
      - httpApi:
          path: /auth/login
          method: post
    environment:
      LOG_LEVEL: INFO
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:GetItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}
          - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}/index/*
      - Effect: Allow
        Action:
          - secretsmanager:GetSecretValue
        Resource:
          - arn:aws:secretsmanager:${self:provider.region}:*:secret:${self:service}-${self:provider.stage}-jwt-secret*

  passwordResetRequest:
    handler: api/auth/password-reset-request.handler
    description: Request password reset token (sends email)
    memorySize: 256
    timeout: 10
    events:
      - httpApi:
          path: /auth/password-reset/request
          method: post
    environment:
      LOG_LEVEL: INFO
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:GetItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}
          - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}/index/*
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/PasswordResetTokens-${self:provider.stage}
      - Effect: Allow
        Action:
          - ses:SendEmail
          - ses:SendTemplatedEmail
        Resource: "*"

  passwordResetConfirm:
    handler: api/auth/password-reset-confirm.handler
    description: Confirm password reset with token
    memorySize: 512     # hashing new password can be CPU-bound
    timeout: 10
    events:
      - httpApi:
          path: /auth/password-reset/confirm
          method: post
    environment:
      LOG_LEVEL: INFO
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:DeleteItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/PasswordResetTokens-${self:provider.stage}
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}

  # -----------------------
  # Staff (protected)
  # -----------------------
  staffRegister:
    handler: api/staff/register.handler
    description: Register new staff (admin only)
    memorySize: 512
    timeout: 10
    events:
      - httpApi:
          path: /staff/register
          method: post
          authorizer:
            name: jwtAuthorizer
    environment:
      LOG_LEVEL: INFO
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}

  staffEnable:
    handler: api/staff/enable.handler
    description: Enable staff account (admin only)
    memorySize: 256
    timeout: 10
    events:
      - httpApi:
          path: /staff/enable
          method: post
          authorizer:
            name: jwtAuthorizer
    environment:
      LOG_LEVEL: INFO
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}

  staffDisable:
    handler: api/staff/disable.handler
    description: Disable staff account (admin only)
    memorySize: 256
    timeout: 10
    events:
      - httpApi:
          path: /staff/disable
          method: post
          authorizer:
            name: jwtAuthorizer
    environment:
      LOG_LEVEL: INFO
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}

  staffMe:
    handler: api/staff/me.handler
    description: Get current staff profile
    memorySize: 256
    timeout: 10
    events:
      - httpApi:
          path: /staff/me
          method: get
          authorizer:
            name: jwtAuthorizer
    environment:
      LOG_LEVEL: INFO
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}

  # -----------------------
  # Tenant (protected)
  # -----------------------
  tenantRegister:
    handler: api/tenant/register.handler
    description: Register new tenant (admin/manager only)
    memorySize: 256
    timeout: 10
    events:
      - httpApi:
          path: /tenant/register
          method: post
          authorizer:
            name: jwtAuthorizer
    environment:
      LOG_LEVEL: INFO
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:*:table/Tenants-${self:provider.stage}

resources:
  Resources:
    StaffTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Staff-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: staff_id
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: staff_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: EmailIndex
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true

    PasswordResetTokensTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: PasswordResetTokens-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: token_hash
            AttributeType: S
        KeySchema:
          - AttributeName: token_hash
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: expires_at
          Enabled: true
        SSESpecification:
          SSEEnabled: true

    TenantsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Tenants-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
