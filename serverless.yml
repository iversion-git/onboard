# ============================================================================
# DEPLOYMENT CONFIGURATION - Edit these values to customize your deployment
# ============================================================================

service: aws-lambda-control-plane  # Change this for multiple stacks
frameworkVersion: '4'

# ============================================================================
# CONFIGURATION VARIABLES - EDIT THESE VALUES
# ============================================================================
custom:
  # Basic Settings
  config:
    defaultStage: dev
    defaultRegion: ap-southeast-2
    awsProfile: node
    
    # Security Configuration - CHANGE THESE!
    jwtSecret: r2P19YQ0kv59MUGL5Ppi9pvGnmmaerxpBox5i0PRpBNd3J1IKptaphEIf7Lbe9BI  # Generate new: node scripts/generate-jwt-secret.js
    sesFromEmail: noreply@example.com
    
    # Performance Configuration
    lambdaMemory: 1024
    lambdaTimeout: 29  # Reduced to avoid HTTP API timeout warning
    lambdaArchitecture: arm64
    # Removed reserved and provisioned concurrency to minimize costs
    # reservedConcurrency: 100
    # provisionedConcurrency: 5
    
    # CORS Configuration by Stage
    corsOrigins:
      dev: "*"
      staging: "https://staging.example.com"
      prod: "https://app.example.com"
    
    # Cross-Account Deployment Configuration
    crossAccount:
      # List of AWS account IDs allowed for cross-account deployments
      # Format: comma-separated string of 12-digit account IDs
      allowedAccountIds: "078607863013"  # Your AWS account ID
      rolePrefix: "ControlPlane-CrossAccount-Role"
    
    # S3 Configuration for CloudFormation Templates
    s3:
      templateBucket: "${self:service}-templates-${self:provider.stage}"
    
    # Performance Monitoring Thresholds
    performance:
      p50ResponseTime: 300
      p95ResponseTime: 500
      p95ColdStart: 1200
    
    # CloudWatch Alarms Configuration
    alarms:
      lambdaDurationThreshold: 500
      lambdaErrorThreshold: 10
      api4xxErrorThreshold: 20
      api5xxErrorThreshold: 5

  # Built-in ESBuild configuration for Serverless v4
  build:
    esbuild:
      bundle: true
      minify: true
      sourcemap: true
      target: node24
      format: esm
      platform: node
      mainFields: [module, main]
      exclude: []
      
  # esbuild configuration (legacy - keeping for reference but not used)
  esbuild:
    bundle: true
    minify: true
    sourcemap: true
    target: node24
    format: esm
    platform: node
    outExtension:
      .js: .mjs
    mainFields: [module, main]
    external: []
    packager: pnpm
    installExtraArgs: ['--frozen-lockfile']
    keepOutputDirectory: true
    exclude: []
    treeShaking: true
    entryPoints:
      - index.ts
    watch:
      pattern: ['**/*.ts', '**/*.js']
      ignore: ['node_modules/**', 'dist/**', '.serverless/**', 'tests/**']

# ============================================================================
# PROVIDER CONFIGURATION - Uses variables from above
# ============================================================================
provider:
  name: aws
  runtime: nodejs24.x
  stage: ${opt:stage, self:custom.config.defaultStage}
  region: ${opt:region, self:custom.config.defaultRegion}
  memorySize: ${self:custom.config.lambdaMemory}
  timeout: ${self:custom.config.lambdaTimeout}
  architecture: ${self:custom.config.lambdaArchitecture}
  environment:
    STAGE: ${self:provider.stage}
    NODE_ENV: ${self:provider.stage}
    # DynamoDB table names with stage-scoped naming
    DYNAMODB_STAFF_TABLE: Staff-${self:provider.stage}
    DYNAMODB_PASSWORD_RESET_TOKENS_TABLE: PasswordResetTokens-${self:provider.stage}
    DYNAMODB_TENANTS_TABLE: Tenants-${self:provider.stage}
    DYNAMODB_CLUSTERS_TABLE: Clusters-${self:provider.stage}
    # JWT secret from config (Requirements 9.6)
    JWT_SECRET: ${self:custom.config.jwtSecret}
    # SES configuration from config
    SES_FROM_EMAIL: ${self:custom.config.sesFromEmail}
    # CORS origins for environment-specific configuration (Requirements 9.5)
    CORS_ORIGINS: ${self:custom.config.corsOrigins.${self:provider.stage}}
    # Security configuration
    BCRYPT_ROUNDS: "12"
    # Cross-account deployment configuration
    CLOUDFORMATION_ALLOWED_ACCOUNT_IDS: ${self:custom.config.crossAccount.allowedAccountIds}
    CLOUDFORMATION_CROSS_ACCOUNT_ROLE_PREFIX: ${self:custom.config.crossAccount.rolePrefix}
    # S3 template bucket for CloudFormation templates
    S3_TEMPLATE_BUCKET: ${self:custom.config.s3.templateBucket}
  iam:
    role:
      statements:
        # DynamoDB permissions with least-privilege access (Requirements 9.4)
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            - dynamodb:Scan
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}
            - arn:aws:dynamodb:${self:provider.region}:*:table/Staff-${self:provider.stage}/index/*
            - arn:aws:dynamodb:${self:provider.region}:*:table/PasswordResetTokens-${self:provider.stage}
            - arn:aws:dynamodb:${self:provider.region}:*:table/Tenants-${self:provider.stage}
            - arn:aws:dynamodb:${self:provider.region}:*:table/Clusters-${self:provider.stage}
        # SES permissions with least-privilege access (Requirements 9.4)
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: 
            - arn:aws:ses:${self:provider.region}:*:identity/*
        # S3 permissions for CloudFormation template storage
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
            - s3:ListBucket
          Resource:
            - arn:aws:s3:::${self:custom.config.s3.templateBucket}
            - arn:aws:s3:::${self:custom.config.s3.templateBucket}/*
        # CloudFormation permissions for cross-account deployments
        - Effect: Allow
          Action:
            - cloudformation:CreateStack
            - cloudformation:UpdateStack
            - cloudformation:DeleteStack
            - cloudformation:DescribeStacks
            - cloudformation:DescribeStackEvents
            - cloudformation:ListStacks
            - cloudformation:ValidateTemplate
          Resource: "*"
        # STS permissions for cross-account role assumption
        - Effect: Allow
          Action:
            - sts:AssumeRole
            - sts:GetCallerIdentity
          Resource: "*"
        # X-Ray tracing permissions for observability (Requirements 10.3, 10.4)
        - Effect: Allow
          Action:
            - xray:PutTraceSegments
            - xray:PutTelemetryRecords
          Resource: "*"
        # CloudWatch Logs permissions for structured logging
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: 
            - arn:aws:logs:${self:provider.region}:*:log-group:/aws/lambda/${self:service}-${self:provider.stage}-*
  tracing:
    lambda: true
    apiGateway: true
  httpApi:
    # HTTP API Gateway configuration for single function (Requirements 8.4)
    name: ${self:service}-${self:provider.stage}-api
    cors:
      allowedOrigins:
        - ${self:custom.config.corsOrigins.${self:provider.stage}}
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Amz-Date
        - X-Api-Key
        - X-Amz-Security-Token
        - X-Amz-User-Agent
        - X-Correlation-ID
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: false
      maxAge: 86400

# ============================================================================
# ============================================================================
# FUNCTIONS CONFIGURATION
# ============================================================================
functions:
  # Single Lambda function with internal routing (Requirements 8.1, 8.2, 8.4)
  api:
    name: ${self:service}-${self:provider.stage}-api
    handler: index.handler
    description: "Single Lambda function handling all API endpoints with internal routing"
    # API Gateway proxy integration with /{proxy+} routing (Requirements 8.4)
    events:
      - httpApi:
          path: /{proxy+}
          method: ANY
      - httpApi:
          path: /
          method: ANY
    environment:
      # Function-specific environment variables
      FUNCTION_NAME: ${self:service}-${self:provider.stage}-api
    # Removed concurrency settings to minimize costs when not in use
    # reservedConcurrency: ${self:custom.config.reservedConcurrency}
    # provisionedConcurrency: ${self:custom.config.provisionedConcurrency}

# ============================================================================
# PLUGINS
# ============================================================================
# Note: Serverless v4 has built-in ESBuild support, no plugin needed

# ============================================================================
# AWS RESOURCES
# ============================================================================
resources:
  Resources:
    # DynamoDB Tables with stage-scoped naming (Requirements 8.4)
    
    # Staff Table
    StaffTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Staff-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: staff_id
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: staff_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: EmailIndex
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Architecture
            Value: single-function

    # Password Reset Tokens Table
    PasswordResetTokensTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: PasswordResetTokens-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: token_hash
            AttributeType: S
        KeySchema:
          - AttributeName: token_hash
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: expires_at
          Enabled: true
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Architecture
            Value: single-function

    # Tenants Table
    TenantsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Tenants-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Architecture
            Value: single-function

    # Clusters Table
    ClustersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Clusters-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: cluster_id
            AttributeType: S
        KeySchema:
          - AttributeName: cluster_id
            KeyType: HASH
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Architecture
            Value: single-function

    # S3 Bucket for CloudFormation Templates
    TemplatesBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.config.s3.templateBucket}
        VersioningConfiguration:
          Status: Enabled
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Purpose
            Value: cloudformation-templates

    # CloudWatch Alarms for Performance Monitoring (Requirements 10.3, 10.4)
    
    # Lambda Duration Alarm (p95 response time)
    LambdaDurationAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-lambda-duration-p95
        AlarmDescription: "Lambda function p95 duration exceeds threshold"
        MetricName: Duration
        Namespace: AWS/Lambda
        Statistic: Average
        Period: 300
        EvaluationPeriods: 2
        Threshold: ${self:custom.config.alarms.lambdaDurationThreshold}
        ComparisonOperator: GreaterThanThreshold
        Dimensions:
          - Name: FunctionName
            Value: ${self:service}-${self:provider.stage}-api
        TreatMissingData: notBreaching

    # Lambda Error Rate Alarm
    LambdaErrorRateAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-lambda-error-rate
        AlarmDescription: "Lambda function error rate exceeds threshold"
        MetricName: Errors
        Namespace: AWS/Lambda
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 2
        Threshold: ${self:custom.config.alarms.lambdaErrorThreshold}
        ComparisonOperator: GreaterThanThreshold
        Dimensions:
          - Name: FunctionName
            Value: ${self:service}-${self:provider.stage}-api
        TreatMissingData: notBreaching

    # API Gateway 4xx Error Alarm
    ApiGateway4xxAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-api-4xx-errors
        AlarmDescription: "API Gateway 4xx error rate exceeds threshold"
        MetricName: 4XXError
        Namespace: AWS/ApiGateway
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 2
        Threshold: ${self:custom.config.alarms.api4xxErrorThreshold}
        ComparisonOperator: GreaterThanThreshold
        Dimensions:
          - Name: ApiName
            Value: ${self:service}-${self:provider.stage}-api
        TreatMissingData: notBreaching

    # API Gateway 5xx Error Alarm
    ApiGateway5xxAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-api-5xx-errors
        AlarmDescription: "API Gateway 5xx error rate exceeds threshold"
        MetricName: 5XXError
        Namespace: AWS/ApiGateway
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 1
        Threshold: ${self:custom.config.alarms.api5xxErrorThreshold}
        ComparisonOperator: GreaterThanThreshold
        Dimensions:
          - Name: ApiName
            Value: ${self:service}-${self:provider.stage}-api
        TreatMissingData: notBreaching

  Outputs:
    # API Gateway outputs
    ApiUrl:
      Description: HTTP API Gateway URL for single function
      Value:
        Fn::Join:
          - ''
          - - 'https://'
            - Ref: HttpApi
            - '.execute-api.'
            - ${self:provider.region}
            - '.amazonaws.com'
      Export:
        Name: ${self:service}-${self:provider.stage}-api-url
    
    ApiId:
      Description: HTTP API Gateway ID
      Value:
        Ref: HttpApi
      Export:
        Name: ${self:service}-${self:provider.stage}-api-id
    
    # Lambda function outputs
    LambdaFunctionName:
      Description: Single Lambda function name
      Value: ${self:service}-${self:provider.stage}-api
      Export:
        Name: ${self:service}-${self:provider.stage}-lambda-name
    
    LambdaFunctionArn:
      Description: Single Lambda function ARN
      Value:
        Fn::GetAtt: [ApiLambdaFunction, Arn]
      Export:
        Name: ${self:service}-${self:provider.stage}-lambda-arn
    
    # DynamoDB table outputs
    StaffTableName:
      Description: Staff DynamoDB Table Name
      Value: Staff-${self:provider.stage}
      Export:
        Name: ${self:service}-${self:provider.stage}-staff-table
    
    PasswordResetTokensTableName:
      Description: Password Reset Tokens DynamoDB Table Name
      Value: PasswordResetTokens-${self:provider.stage}
      Export:
        Name: ${self:service}-${self:provider.stage}-password-reset-tokens-table
    
    TenantsTableName:
      Description: Tenants DynamoDB Table Name
      Value: Tenants-${self:provider.stage}
      Export:
        Name: ${self:service}-${self:provider.stage}-tenants-table
    
    ClustersTableName:
      Description: Clusters DynamoDB Table Name
      Value: Clusters-${self:provider.stage}
      Export:
        Name: ${self:service}-${self:provider.stage}-clusters-table
    
    # S3 bucket outputs
    TemplatesBucketName:
      Description: S3 Bucket for CloudFormation Templates
      Value: ${self:custom.config.s3.templateBucket}
      Export:
        Name: ${self:service}-${self:provider.stage}-templates-bucket
    
    # Performance monitoring outputs
    PerformanceThresholds:
      Description: Performance monitoring thresholds
      Value:
        Fn::Sub: "p50: ${self:custom.config.performance.p50ResponseTime}ms, p95: ${self:custom.config.performance.p95ResponseTime}ms, cold start p95: ${self:custom.config.performance.p95ColdStart}ms"
      Export:
        Name: ${self:service}-${self:provider.stage}-performance-thresholds