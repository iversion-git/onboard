# ============================================================================
# DEPLOYMENT CONFIGURATION - Edit these values to customize your deployment
# ============================================================================

service: onboard-service  # Updated to use onboard-service naming
frameworkVersion: '4'

# ============================================================================
# CONFIGURATION VARIABLES - EDIT THESE VALUES
# ============================================================================
custom:
  # Basic Settings
  config:
    defaultStage: dev
    defaultRegion: ap-southeast-2
    awsProfile: node
    
    # Security Configuration - CHANGE THESE!
    jwtSecret: r2P19YQ0kv59MUGL5Ppi9pvGnmmaerxpBox5i0PRpBNd3J1IKptaphEIf7Lbe9BI  # Generate new: node scripts/generate-jwt-secret.js
    
    # SES Configuration by Stage
    sesFromEmail:
      dev: onboard-dev@flowrix.app     # Development environment sender
      staging: onboard-staging@flowrix.app  # Staging environment sender  
      prod: onboard@flowrix.app        # Production environment sender
    
    # Performance Configuration
    lambdaMemory: 1024
    lambdaTimeout: 29  # Reduced to avoid HTTP API timeout warning
    lambdaArchitecture: arm64
    # Removed reserved and provisioned concurrency to minimize costs
    # reservedConcurrency: 100
    # provisionedConcurrency: 5
    
    # CORS Configuration by Stage
    corsOrigins:
      dev: "*"
      staging: "https://staging.example.com"
      prod: "https://app.example.com"
    
    # Cross-Account Deployment Configuration
    crossAccount:
      # List of AWS account IDs allowed for cross-account deployments
      # Format: comma-separated string of 12-digit account IDs
      allowedAccountIds: "078607863013"  # Your AWS account ID
      rolePrefix: "ControlPlane-CrossAccount-Role"
    
    # S3 Configuration for CloudFormation Templates
    s3:
      templateBucket: "onboard-templates-${self:provider.stage}"
    
    # Performance Monitoring Thresholds
    performance:
      p50ResponseTime: 300
      p95ResponseTime: 500
      p95ColdStart: 1200
    
    # CloudWatch Alarms Configuration
    alarms:
      lambdaDurationThreshold: 500
      lambdaErrorThreshold: 10
      api4xxErrorThreshold: 20
      api5xxErrorThreshold: 5

  # Built-in ESBuild configuration for Serverless v4
  build:
    esbuild:
      bundle: true
      minify: true
      sourcemap: true
      target: node24
      format: esm
      platform: node
      mainFields: [module, main]
      exclude: []
      
  # esbuild configuration (legacy - keeping for reference but not used)
  esbuild:
    bundle: true
    minify: true
    sourcemap: true
    target: node24
    format: esm
    platform: node
    outExtension:
      .js: .mjs
    mainFields: [module, main]
    external: []
    packager: pnpm
    installExtraArgs: ['--frozen-lockfile']
    keepOutputDirectory: true
    exclude: []
    treeShaking: true
    entryPoints:
      - index.ts
    watch:
      pattern: ['**/*.ts', '**/*.js']
      ignore: ['node_modules/**', 'dist/**', '.serverless/**', 'tests/**']

# ============================================================================
# PROVIDER CONFIGURATION - Uses variables from above
# ============================================================================
provider:
  name: aws
  runtime: nodejs24.x
  stage: ${opt:stage, self:custom.config.defaultStage}
  region: ${opt:region, self:custom.config.defaultRegion}
  memorySize: ${self:custom.config.lambdaMemory}
  timeout: ${self:custom.config.lambdaTimeout}
  architecture: ${self:custom.config.lambdaArchitecture}
  environment:
    STAGE: ${self:provider.stage}
    NODE_ENV: ${self:provider.stage}
    # DynamoDB table names with onboard-service naming convention
    DYNAMODB_STAFF_TABLE: onboard-staff-${self:provider.stage}
    DYNAMODB_PASSWORD_RESET_TOKENS_TABLE: onboard-password-reset-tokens-${self:provider.stage}
    DYNAMODB_TENANTS_TABLE: onboard-tenants-${self:provider.stage}
    DYNAMODB_PACKAGES_TABLE: onboard-packages-${self:provider.stage}
    DYNAMODB_SUBSCRIPTION_TYPES_TABLE: onboard-subscription-types-${self:provider.stage}
    DYNAMODB_SUBSCRIPTIONS_TABLE: onboard-subscriptions-${self:provider.stage}
    DYNAMODB_CLUSTERS_TABLE: onboard-clusters-${self:provider.stage}
    DYNAMODB_LANDLORD_TABLE: landlord-${self:provider.stage}
    # JWT secret from config (Requirements 9.6)
    JWT_SECRET: ${self:custom.config.jwtSecret}
    # SES configuration from config (stage-specific)
    SES_FROM_EMAIL: ${self:custom.config.sesFromEmail.${self:provider.stage}}
    # CORS origins for environment-specific configuration (Requirements 9.5)
    CORS_ORIGINS: ${self:custom.config.corsOrigins.${self:provider.stage}}
    # Security configuration
    BCRYPT_ROUNDS: "12"
    # Cross-account deployment configuration
    CLOUDFORMATION_ALLOWED_ACCOUNT_IDS: ${self:custom.config.crossAccount.allowedAccountIds}
    CLOUDFORMATION_CROSS_ACCOUNT_ROLE_PREFIX: ${self:custom.config.crossAccount.rolePrefix}
    # S3 template bucket for CloudFormation templates
    S3_TEMPLATE_BUCKET: ${self:custom.config.s3.templateBucket}
  iam:
    role:
      statements:
        # Administrator access for development - will fine-tune permissions later
        - Effect: Allow
          Action: "*"
          Resource: "*"
  tracing:
    lambda: true
    apiGateway: true
  apiGateway:
    # Use v1 as API stage regardless of deployment stage
    stage: v1

# ============================================================================
# ============================================================================
# FUNCTIONS CONFIGURATION
# ============================================================================
functions:
  # Single Lambda function with internal routing (Requirements 8.1, 8.2, 8.4)
  api:
    name: onboard-api-${self:provider.stage}
    handler: index.handler
    description: "Single Lambda function handling all API endpoints with internal routing"
    # API Gateway proxy integration with /{proxy+} routing (Requirements 8.4)
    events:
      - http:
          path: /{proxy+}
          method: ANY
          cors:
            origin: ${self:custom.config.corsOrigins.${self:provider.stage}}
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - X-Correlation-ID
            allowCredentials: false
      - http:
          path: /
          method: ANY
          cors:
            origin: ${self:custom.config.corsOrigins.${self:provider.stage}}
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - X-Correlation-ID
            allowCredentials: false
    environment:
      # Function-specific environment variables
      FUNCTION_NAME: onboard-api-${self:provider.stage}
    # Removed concurrency settings to minimize costs when not in use
    # reservedConcurrency: ${self:custom.config.reservedConcurrency}
    # provisionedConcurrency: ${self:custom.config.provisionedConcurrency}

# ============================================================================
# PLUGINS
# ============================================================================
# Note: Serverless v4 has built-in ESBuild support, no plugin needed

# ============================================================================
# AWS RESOURCES
# ============================================================================
resources:
  Resources:
    # DynamoDB Tables with stage-scoped naming (Requirements 8.4)
    
    # Staff Table
    StaffTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: onboard-staff-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: staff_id
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: staff_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: EmailIndex
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Service
            Value: onboard-service
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Architecture
            Value: single-function

    # Password Reset Tokens Table
    PasswordResetTokensTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: onboard-password-reset-tokens-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: token_hash
            AttributeType: S
        KeySchema:
          - AttributeName: token_hash
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: expires_at
          Enabled: true
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Service
            Value: onboard-service
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Architecture
            Value: single-function

    # Tenants Table
    TenantsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: onboard-tenants-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Service
            Value: onboard-service
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Architecture
            Value: single-function

    # Packages Table
    PackagesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: onboard-packages-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: package_id
            AttributeType: N
        KeySchema:
          - AttributeName: package_id
            KeyType: HASH
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Service
            Value: onboard-service
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Architecture
            Value: single-function

    # Subscription Types Table
    SubscriptionTypesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: onboard-subscription-types-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: subscription_type_id
            AttributeType: N
        KeySchema:
          - AttributeName: subscription_type_id
            KeyType: HASH
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Service
            Value: onboard-service
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Architecture
            Value: single-function

    # Subscriptions Table
    SubscriptionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: onboard-subscriptions-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: subscription_id
            AttributeType: S
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: subscription_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: TenantIndex
            KeySchema:
              - AttributeName: tenant_id
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Service
            Value: onboard-service
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Architecture
            Value: single-function

    # Clusters Table
    ClustersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: onboard-clusters-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: cluster_id
            AttributeType: S
        KeySchema:
          - AttributeName: cluster_id
            KeyType: HASH
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Service
            Value: onboard-service
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Architecture
            Value: single-function

    # Landlord Global Table - Multi-region replication
    LandlordGlobalTable:
      Type: AWS::DynamoDB::GlobalTable
      Properties:
        TableName: landlord-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        SSESpecification:
          SSEEnabled: true
        Replicas:
          - Region: ap-southeast-2
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: true
            TableClass: STANDARD
            Tags:
              - Key: Service
                Value: onboard-service
              - Key: Stage
                Value: ${self:provider.stage}
              - Key: TableType
                Value: global-table
              - Key: Region
                Value: ap-southeast-2
          - Region: us-east-1
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: true
            TableClass: STANDARD
            Tags:
              - Key: Service
                Value: onboard-service
              - Key: Stage
                Value: ${self:provider.stage}
              - Key: TableType
                Value: global-table
              - Key: Region
                Value: us-east-1
          - Region: eu-central-1
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: true
            TableClass: STANDARD
            Tags:
              - Key: Service
                Value: onboard-service
              - Key: Stage
                Value: ${self:provider.stage}
              - Key: TableType
                Value: global-table
              - Key: Region
                Value: eu-central-1
          - Region: eu-west-2
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: true
            TableClass: STANDARD
            Tags:
              - Key: Service
                Value: onboard-service
              - Key: Stage
                Value: ${self:provider.stage}
              - Key: TableType
                Value: global-table
              - Key: Region
                Value: eu-west-2
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES

    # S3 Bucket for CloudFormation Templates
    TemplatesBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.config.s3.templateBucket}
        VersioningConfiguration:
          Status: Enabled
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        Tags:
          - Key: Service
            Value: onboard-service
          - Key: Stage
            Value: ${self:provider.stage}
          - Key: Purpose
            Value: cloudformation-templates

    # CloudWatch Alarms for Performance Monitoring (Requirements 10.3, 10.4)
    
    # Lambda Duration Alarm (p95 response time)
    LambdaDurationAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: onboard-service-${self:provider.stage}-lambda-duration-p95
        AlarmDescription: "Lambda function p95 duration exceeds threshold"
        MetricName: Duration
        Namespace: AWS/Lambda
        Statistic: Average
        Period: 300
        EvaluationPeriods: 2
        Threshold: ${self:custom.config.alarms.lambdaDurationThreshold}
        ComparisonOperator: GreaterThanThreshold
        Dimensions:
          - Name: FunctionName
            Value: onboard-api-${self:provider.stage}
        TreatMissingData: notBreaching

    # Lambda Error Rate Alarm
    LambdaErrorRateAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: onboard-service-${self:provider.stage}-lambda-error-rate
        AlarmDescription: "Lambda function error rate exceeds threshold"
        MetricName: Errors
        Namespace: AWS/Lambda
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 2
        Threshold: ${self:custom.config.alarms.lambdaErrorThreshold}
        ComparisonOperator: GreaterThanThreshold
        Dimensions:
          - Name: FunctionName
            Value: onboard-api-${self:provider.stage}
        TreatMissingData: notBreaching

    # API Gateway 4xx Error Alarm
    ApiGateway4xxAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: onboard-service-${self:provider.stage}-api-4xx-errors
        AlarmDescription: "API Gateway 4xx error rate exceeds threshold"
        MetricName: 4XXError
        Namespace: AWS/ApiGateway
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 2
        Threshold: ${self:custom.config.alarms.api4xxErrorThreshold}
        ComparisonOperator: GreaterThanThreshold
        Dimensions:
          - Name: ApiName
            Value: onboard-api-${self:provider.stage}
          - Name: Stage
            Value: ${self:provider.stage}
        TreatMissingData: notBreaching

    # API Gateway 5xx Error Alarm
    ApiGateway5xxAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: onboard-service-${self:provider.stage}-api-5xx-errors
        AlarmDescription: "API Gateway 5xx error rate exceeds threshold"
        MetricName: 5XXError
        Namespace: AWS/ApiGateway
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 1
        Threshold: ${self:custom.config.alarms.api5xxErrorThreshold}
        ComparisonOperator: GreaterThanThreshold
        Dimensions:
          - Name: ApiName
            Value: onboard-api-${self:provider.stage}
          - Name: Stage
            Value: ${self:provider.stage}
        TreatMissingData: notBreaching

  Outputs:
    # Lambda function outputs
    LambdaFunctionName:
      Description: Single Lambda function name
      Value: onboard-api-${self:provider.stage}
      Export:
        Name: onboard-service-${self:provider.stage}-lambda-name
    
    LambdaFunctionArn:
      Description: Single Lambda function ARN
      Value:
        Fn::GetAtt: [ApiLambdaFunction, Arn]
      Export:
        Name: onboard-service-${self:provider.stage}-lambda-arn
    
    # DynamoDB table outputs
    StaffTableName:
      Description: Staff DynamoDB Table Name
      Value: onboard-staff-${self:provider.stage}
      Export:
        Name: onboard-service-${self:provider.stage}-staff-table
    
    PasswordResetTokensTableName:
      Description: Password Reset Tokens DynamoDB Table Name
      Value: onboard-password-reset-tokens-${self:provider.stage}
      Export:
        Name: onboard-service-${self:provider.stage}-password-reset-tokens-table
    
    TenantsTableName:
      Description: Tenants DynamoDB Table Name
      Value: onboard-tenants-${self:provider.stage}
      Export:
        Name: onboard-service-${self:provider.stage}-tenants-table

    PackagesTableName:
      Description: Packages DynamoDB Table Name
      Value: onboard-packages-${self:provider.stage}
      Export:
        Name: onboard-service-${self:provider.stage}-packages-table

    SubscriptionTypesTableName:
      Description: Subscription Types DynamoDB Table Name
      Value: onboard-subscription-types-${self:provider.stage}
      Export:
        Name: onboard-service-${self:provider.stage}-subscription-types-table

    SubscriptionsTableName:
      Description: Subscriptions DynamoDB Table Name
      Value: onboard-subscriptions-${self:provider.stage}
      Export:
        Name: onboard-service-${self:provider.stage}-subscriptions-table
    
    ClustersTableName:
      Description: Clusters DynamoDB Table Name
      Value: onboard-clusters-${self:provider.stage}
      Export:
        Name: onboard-service-${self:provider.stage}-clusters-table

    LandlordTableName:
      Description: Landlord Global DynamoDB Table Name
      Value: landlord-${self:provider.stage}
      Export:
        Name: onboard-service-${self:provider.stage}-landlord-table
    
    # S3 bucket outputs
    TemplatesBucketName:
      Description: S3 Bucket for CloudFormation Templates
      Value: ${self:custom.config.s3.templateBucket}
      Export:
        Name: onboard-service-${self:provider.stage}-templates-bucket
    
    # Performance monitoring outputs
    PerformanceThresholds:
      Description: Performance monitoring thresholds
      Value:
        Fn::Sub: "p50: ${self:custom.config.performance.p50ResponseTime}ms, p95: ${self:custom.config.performance.p95ResponseTime}ms, cold start p95: ${self:custom.config.performance.p95ColdStart}ms"
      Export:
        Name: onboard-service-${self:provider.stage}-performance-thresholds