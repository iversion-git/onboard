AWSTemplateFormatVersion: '2010-09-09'
Description: >
  VPC infrastructure with Aurora MySQL Serverless v2.
  Creates VPC, subnets, security groups, and Aurora MySQL database.
  NAT Gateway is optional and separate from database resources.

Parameters:
  EnvironmentName:
    Type: String
    Description: Environment identifier
    MinLength: 1
    MaxLength: 50
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9-]*$

  VpcCIDR:
    Type: String
    Description: CIDR block for the VPC
    Default: 10.0.0.0/16

  ClusterName:
    Type: String
    Description: Name of the cluster
    MinLength: 1
    MaxLength: 255

  ClusterType:
    Type: String
    Description: Type of cluster
    AllowedValues: [Shared, Dedicated]

  ClusterEnvironment:
    Type: String
    Description: Environment of cluster
    AllowedValues: [Production, Staging, Dev]

Resources:
  # ==========================================
  # VPC and Basic Networking (No Dependencies)
  # ==========================================
  
  VPC:
    Type: AWS::EC2::VPC
    DeletionPolicy: Delete
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Ref ClusterName

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-InternetGateway

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # ==========================================
  # Subnets (Only depend on VPC)
  # ==========================================
  
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [0, !Cidr [!Ref VpcCIDR, 6, 8]]
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PublicSubnet-AZ1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [1, !Cidr [!Ref VpcCIDR, 6, 8]]
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PublicSubnet-AZ2

  PrivateAppSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [2, !Cidr [!Ref VpcCIDR, 6, 8]]
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateAppSubnet-AZ1

  PrivateAppSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [3, !Cidr [!Ref VpcCIDR, 6, 8]]
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateAppSubnet-AZ2

  PrivateDBSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [4, !Cidr [!Ref VpcCIDR, 6, 8]]
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateDBSubnet-AZ1

  PrivateDBSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [5, !Cidr [!Ref VpcCIDR, 6, 8]]
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateDBSubnet-AZ2

  # ==========================================
  # Security Groups (Only depend on VPC)
  # ==========================================
  
  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvironmentName}-AppSecurityGroup
      GroupDescription: Security group for application workloads
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: Allow HTTPS to internet
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          DestinationSecurityGroupId: !Ref DBSecurityGroup
          Description: Allow MySQL to DB Security Group
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-AppSecurityGroup

  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvironmentName}-DBSecurityGroup
      GroupDescription: Security group for database resources
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref AppSecurityGroup
          Description: Allow MySQL from App Security Group
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-DBSecurityGroup

  # ==========================================
  # Aurora MySQL Database (No NAT Gateway dependency)
  # ==========================================
  
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    DeletionPolicy: Delete
    Properties:
      DBSubnetGroupName: !Sub ${EnvironmentName}-db-subnet-group
      DBSubnetGroupDescription: Subnet group for Aurora MySQL cluster
      SubnetIds:
        - !Ref PrivateDBSubnet1
        - !Ref PrivateDBSubnet2
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-db-subnet-group

  AuroraCluster:
    Type: AWS::RDS::DBCluster
    DeletionPolicy: Delete
    DependsOn:
      - DBSubnetGroup
      - DBSecurityGroup
    Properties:
      DBClusterIdentifier: !Sub ${EnvironmentName}-aurora-mysql
      Engine: aurora-mysql
      EngineMode: provisioned
      ServerlessV2ScalingConfiguration:
        MinCapacity: 0.5
        MaxCapacity: 128
      MasterUsername: admin
      ManageMasterUserPassword: true
      DatabaseName: appdb
      DBSubnetGroupName: !Ref DBSubnetGroup
      VpcSecurityGroupIds:
        - !Ref DBSecurityGroup
      BackupRetentionPeriod: 7
      PreferredBackupWindow: "03:00-04:00"
      PreferredMaintenanceWindow: "sun:04:00-sun:05:00"
      EnableCloudwatchLogsExports:
        - error
        - general
        - slowquery
      DeletionProtection: false
      StorageEncrypted: true
      StorageType: aurora-iopt1
      CopyTagsToSnapshot: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-aurora-mysql

  AuroraWriterInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Delete
    Properties:
      DBInstanceIdentifier: !Sub ${EnvironmentName}-aurora-writer
      DBClusterIdentifier: !Ref AuroraCluster
      DBInstanceClass: db.serverless
      Engine: aurora-mysql
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-aurora-writer

  # ==========================================
  # RDS Proxy (Depends only on Aurora)
  # ==========================================
  
  DBProxyRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-rds-proxy-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: rds.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                Resource: !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:rds-db-credentials/*'

  DBProxy:
    Type: AWS::RDS::DBProxy
    DeletionPolicy: Delete
    DependsOn: AuroraCluster
    Properties:
      DBProxyName: !Sub ${EnvironmentName}-aurora-proxy
      EngineFamily: MYSQL
      Auth:
        - AuthScheme: SECRETS
          SecretArn: !GetAtt AuroraCluster.MasterUserSecret.SecretArn
      RoleArn: !GetAtt DBProxyRole.Arn
      VpcSubnetIds:
        - !Ref PrivateDBSubnet1
        - !Ref PrivateDBSubnet2
      VpcSecurityGroupIds:
        - !Ref DBSecurityGroup
      RequireTLS: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-aurora-proxy

  DBProxyTargetGroup:
    Type: AWS::RDS::DBProxyTargetGroup
    DeletionPolicy: Delete
    Properties:
      DBProxyName: !Ref DBProxy
      TargetGroupName: default
      DBClusterIdentifiers:
        - !Ref AuroraCluster

Outputs:
  VPC:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub ${EnvironmentName}-VPC

  VPCCidr:
    Description: VPC CIDR block
    Value: !GetAtt VPC.CidrBlock
    Export:
      Name: !Sub ${EnvironmentName}-VPC-CIDR

  PrivateDBSubnets:
    Description: Private DB Subnet IDs
    Value: !Sub "${PrivateDBSubnet1},${PrivateDBSubnet2}"
    Export:
      Name: !Sub ${EnvironmentName}-PrivateDBSubnets

  AppSecurityGroup:
    Description: App Security Group ID
    Value: !Ref AppSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-AppSecurityGroup

  DBSecurityGroup:
    Description: DB Security Group ID
    Value: !Ref DBSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-DBSecurityGroup

  AuroraClusterEndpoint:
    Description: Aurora MySQL cluster endpoint
    Value: !GetAtt AuroraCluster.Endpoint.Address
    Export:
      Name: !Sub ${EnvironmentName}-AuroraClusterEndpoint

  AuroraClusterReadEndpoint:
    Description: Aurora MySQL cluster read endpoint
    Value: !GetAtt AuroraCluster.ReadEndpoint.Address
    Export:
      Name: !Sub ${EnvironmentName}-AuroraClusterReadEndpoint

  DBProxyEndpoint:
    Description: RDS Proxy endpoint for connection pooling
    Value: !GetAtt DBProxy.Endpoint
    Export:
      Name: !Sub ${EnvironmentName}-DBProxyEndpoint

  DBSecretArn:
    Description: ARN of the database password secret (AWS managed)
    Value: !GetAtt AuroraCluster.MasterUserSecret.SecretArn
    Export:
      Name: !Sub ${EnvironmentName}-DBSecretArn

  DatabaseName:
    Description: Default database name
    Value: appdb
    Export:
      Name: !Sub ${EnvironmentName}-DatabaseName

  TemplateVersion:
    Description: CloudFormation template version
    Value: "1.0.0"