AWSTemplateFormatVersion: '2010-09-09'
Description: >
  VPC infrastructure for serverless applications.
  Creates a three-zone architecture (Private App, Private DB, Public) with NAT Gateway
  for Lambda functions running in VPC with private database access and public resources.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Environment Configuration"
        Parameters:
          - EnvironmentName
      - Label:
          default: "Network Configuration"
        Parameters:
          - VpcCIDR
          - AvailabilityZoneCount
      - Label:
          default: "Private App Zone Subnets"
        Parameters:
          - PrivateAppSubnet1CIDR
          - PrivateAppSubnet2CIDR
          - PrivateAppSubnet3CIDR
      - Label:
          default: "Private DB Zone Subnets"
        Parameters:
          - PrivateDBSubnet1CIDR
          - PrivateDBSubnet2CIDR
          - PrivateDBSubnet3CIDR
      - Label:
          default: "Public Zone Subnets"
        Parameters:
          - PublicSubnet1CIDR
          - PublicSubnet2CIDR
          - PublicSubnet3CIDR
      - Label:
          default: "Resource Tagging"
        Parameters:
          - ProjectName
          - CostCenter
          - Owner
    ParameterLabels:
      EnvironmentName:
        default: "Environment Name"
      VpcCIDR:
        default: "VPC CIDR Block"
      AvailabilityZoneCount:
        default: "Number of Availability Zones"

Parameters:
  EnvironmentName:
    Type: String
    Description: Environment identifier (e.g., prod, staging, dev)
    MinLength: 1
    MaxLength: 50
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9-]*$
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters and hyphens

  VpcCIDR:
    Type: String
    Description: CIDR block for the VPC
    Default: 10.0.0.0/16
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  AvailabilityZoneCount:
    Type: Number
    Description: Number of Availability Zones to use (2 or 3)
    Default: 2
    AllowedValues:
      - 2
      - 3
    ConstraintDescription: Must be 2 or 3

  PrivateAppSubnet1CIDR:
    Type: String
    Description: CIDR block for Private App Subnet in Availability Zone 1
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  PrivateAppSubnet2CIDR:
    Type: String
    Description: CIDR block for Private App Subnet in Availability Zone 2
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  PrivateAppSubnet3CIDR:
    Type: String
    Description: CIDR block for Private App Subnet in Availability Zone 3
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  PrivateDBSubnet1CIDR:
    Type: String
    Description: CIDR block for Private DB Subnet in Availability Zone 1
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  PrivateDBSubnet2CIDR:
    Type: String
    Description: CIDR block for Private DB Subnet in Availability Zone 2
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  PrivateDBSubnet3CIDR:
    Type: String
    Description: CIDR block for Private DB Subnet in Availability Zone 3
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  PublicSubnet1CIDR:
    Type: String
    Description: CIDR block for Public Subnet in Availability Zone 1
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  PublicSubnet2CIDR:
    Type: String
    Description: CIDR block for Public Subnet in Availability Zone 2
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  PublicSubnet3CIDR:
    Type: String
    Description: CIDR block for Public Subnet in Availability Zone 3
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  ProjectName:
    Type: String
    Description: Optional project name for resource tagging
    Default: ""
    MaxLength: 100

  CostCenter:
    Type: String
    Description: Optional cost center identifier for resource tagging
    Default: ""
    MaxLength: 100

  Owner:
    Type: String
    Description: Optional owner or team name for resource tagging
    Default: ""
    MaxLength: 100

  # Cluster-specific parameters for tagging
  ClusterName:
    Type: String
    Description: Name of the cluster for resource tagging
    MinLength: 1
    MaxLength: 255

  ClusterType:
    Type: String
    Description: Type of cluster (Shared or Dedicated) for resource tagging
    AllowedValues:
      - Shared
      - Dedicated
    ConstraintDescription: Must be either Shared or Dedicated

  ClusterEnvironment:
    Type: String
    Description: Environment of cluster (Production, Staging, or Dev) for resource tagging
    AllowedValues:
      - Production
      - Staging
      - Dev
    ConstraintDescription: Must be Production, Staging, or Dev

  ClusterIdShort:
    Type: String
    Description: Short cluster ID (first 8 characters) for resource naming
    MinLength: 8
    MaxLength: 8
    AllowedPattern: ^[a-f0-9]{8}$
    ConstraintDescription: Must be exactly 8 lowercase hexadecimal characters

Conditions:
  # Condition to determine if we should use Availability Zone 3
  UseAZ3: !Equals [!Ref AvailabilityZoneCount, 3]
  
  # Conditions for optional custom tags
  HasProjectName: !Not [!Equals [!Ref ProjectName, '']]
  HasCostCenter: !Not [!Equals [!Ref CostCenter, '']]
  HasOwner: !Not [!Equals [!Ref Owner, '']]
  
  # Environment conditions for lowercase naming
  IsProduction: !Equals [!Ref ClusterEnvironment, 'Production']
  IsStaging: !Equals [!Ref ClusterEnvironment, 'Staging']

Resources:
  # ==========================================
  # VPC and Core Networking
  # ==========================================
  
  VPC:
    Type: AWS::EC2::VPC
    DeletionPolicy: Delete
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub 
            - "${ClusterName}-${Environment}-vpc-${ClusterIdShort}"
            - Environment: !If 
              - IsProduction
              - "prod"
              - !If 
                - IsStaging
                - "staging"
                - "dev"
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - !If
          - HasProjectName
          - Key: Project
            Value: !Ref ProjectName
          - !Ref AWS::NoValue
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  # ==========================================
  # Internet Gateway (for NAT Gateway only)
  # ==========================================
  
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub 
            - "${ClusterName}-${Environment}-igw-${ClusterIdShort}"
            - Environment: !If 
              - IsProduction
              - "prod"
              - !If 
                - IsStaging
                - "staging"
                - "dev"
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # ==========================================
  # Private App Zone Subnets (for Lambda functions)
  # ==========================================
  
  PrivateAppSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateAppSubnet1CIDR
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateAppSubnet-AZ1
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateApp

  PrivateAppSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateAppSubnet2CIDR
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateAppSubnet-AZ2
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateApp

  PrivateAppSubnet3:
    Type: AWS::EC2::Subnet
    Condition: UseAZ3
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateAppSubnet3CIDR
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateAppSubnet-AZ3
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateApp

  # ==========================================
  # Private DB Zone Subnets (for Aurora MySQL)
  # ==========================================
  
  PrivateDBSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateDBSubnet1CIDR
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateDBSubnet-AZ1
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateDB

  PrivateDBSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateDBSubnet2CIDR
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateDBSubnet-AZ2
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateDB

  PrivateDBSubnet3:
    Type: AWS::EC2::Subnet
    Condition: UseAZ3
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateDBSubnet3CIDR
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateDBSubnet-AZ3
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateDB

  # ==========================================
  # Public Zone Subnets (for resources needing direct internet access)
  # ==========================================
  
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet1CIDR
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PublicSubnet-AZ1
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: Public

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet2CIDR
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PublicSubnet-AZ2
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: Public

  PublicSubnet3:
    Type: AWS::EC2::Subnet
    Condition: UseAZ3
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet3CIDR
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PublicSubnet-AZ3
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: Public

  # ==========================================
  # NAT Gateway Infrastructure (for Lambda internet access)
  # ==========================================
  
  # Elastic IP for NAT Gateway
  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub 
            - "${ClusterName}-${Environment}-nat-eip-${ClusterIdShort}"
            - Environment: !If 
              - IsProduction
              - "prod"
              - !If 
                - IsStaging
                - "staging"
                - "dev"
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation

  # NAT Gateway (placed in first Public subnet)
  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub 
            - "${ClusterName}-${Environment}-nat-gw-${ClusterIdShort}"
            - Environment: !If 
              - IsProduction
              - "prod"
              - !If 
                - IsStaging
                - "staging"
                - "dev"
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation

  # ==========================================
  # Route Tables
  # ==========================================
  
  # Route table for Private Zone (DB subnets - VPC internal routing only)
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub 
            - "${ClusterName}-${Environment}-private-rt-${ClusterIdShort}"
            - Environment: !If 
              - IsProduction
              - "prod"
              - !If 
                - IsStaging
                - "staging"
                - "dev"
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateDB

  # Route table for NAT Zone (App subnets - internet via NAT Gateway)
  NATRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub 
            - "${ClusterName}-${Environment}-nat-rt-${ClusterIdShort}"
            - Environment: !If 
              - IsProduction
              - "prod"
              - !If 
                - IsStaging
                - "staging"
                - "dev"
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateApp

  # Route to NAT Gateway for internet access
  NATRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref NATRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  # Route table for Public Zone (Public subnets - internet via IGW)
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub 
            - "${ClusterName}-${Environment}-public-rt-${ClusterIdShort}"
            - Environment: !If 
              - IsProduction
              - "prod"
              - !If 
                - IsStaging
                - "staging"
                - "dev"
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: Public

  # Route to Internet Gateway for direct internet access
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  # ==========================================
  # Subnet Route Table Associations
  # ==========================================
  
  # Associate App subnets with NAT route table (NAT Gateway access)
  PrivateAppSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateAppSubnet1
      RouteTableId: !Ref NATRouteTable

  PrivateAppSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateAppSubnet2
      RouteTableId: !Ref NATRouteTable

  PrivateAppSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseAZ3
    Properties:
      SubnetId: !Ref PrivateAppSubnet3
      RouteTableId: !Ref NATRouteTable

  # Associate DB subnets with Private route table (no internet access)
  PrivateDBSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateDBSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateDBSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateDBSubnet2
      RouteTableId: !Ref PrivateRouteTable

  PrivateDBSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseAZ3
    Properties:
      SubnetId: !Ref PrivateDBSubnet3
      RouteTableId: !Ref PrivateRouteTable

  # Associate Public subnets with Public route table (IGW access)
  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseAZ3
    Properties:
      SubnetId: !Ref PublicSubnet3
      RouteTableId: !Ref PublicRouteTable

  # ==========================================
  # Security Groups
  # ==========================================
  
  # Lambda Security Group (for functions in Private App Zone)
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 
        - "${ClusterName}-${Environment}-lambda-sg-${ClusterIdShort}"
        - Environment: !If 
          - IsProduction
          - "prod"
          - !If 
            - IsStaging
            - "staging"
            - "dev"
      GroupDescription: Security group for Lambda functions in Private App Zone
      VpcId: !Ref VPC
      SecurityGroupEgress:
        # Allow HTTPS traffic to internet (for API calls, package downloads)
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: Allow HTTPS to internet
        # Allow HTTP traffic to internet (for package downloads)
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: Allow HTTP to internet
        # Allow DNS queries (UDP)
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
          Description: Allow DNS queries (UDP)
        # Allow DNS queries (TCP)
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
          Description: Allow DNS queries (TCP)
      Tags:
        - Key: Name
          Value: !Sub 
            - "${ClusterName}-${Environment}-lambda-sg-${ClusterIdShort}"
            - Environment: !If 
              - IsProduction
              - "prod"
              - !If 
                - IsStaging
                - "staging"
                - "dev"
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateApp

  # RDS Security Group (for Aurora MySQL in Private DB Zone)
  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 
        - "${ClusterName}-${Environment}-rds-sg-${ClusterIdShort}"
        - Environment: !If 
          - IsProduction
          - "prod"
          - !If 
            - IsStaging
            - "staging"
            - "dev"
      GroupDescription: Security group for RDS Aurora MySQL in Private DB Zone
      VpcId: !Ref VPC
      SecurityGroupIngress:
        # Allow MySQL access from Lambda Security Group (App subnets)
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: Allow MySQL from Lambda Security Group (App subnets)
      Tags:
        - Key: Name
          Value: !Sub 
            - "${ClusterName}-${Environment}-rds-sg-${ClusterIdShort}"
            - Environment: !If 
              - IsProduction
              - "prod"
              - !If 
                - IsStaging
                - "staging"
                - "dev"
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateDB

  # DB Proxy Security Group (for RDS Proxy in Private DB Zone)
  DBProxySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 
        - "${ClusterName}-${Environment}-dbproxy-sg-${ClusterIdShort}"
        - Environment: !If 
          - IsProduction
          - "prod"
          - !If 
            - IsStaging
            - "staging"
            - "dev"
      GroupDescription: Security group for RDS Proxy in Private DB Zone
      VpcId: !Ref VPC
      SecurityGroupIngress:
        # Allow MySQL access from Lambda Security Group (App subnets)
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: Allow MySQL from Lambda Security Group (App subnets)
      SecurityGroupEgress:
        # Allow MySQL access to RDS Security Group
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          DestinationSecurityGroupId: !Ref RDSSecurityGroup
          Description: Allow MySQL to RDS Security Group
      Tags:
        - Key: Name
          Value: !Sub 
            - "${ClusterName}-${Environment}-dbproxy-sg-${ClusterIdShort}"
            - Environment: !If 
              - IsProduction
              - "prod"
              - !If 
                - IsStaging
                - "staging"
                - "dev"
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateDB

  # Redis Security Group (for ElastiCache Redis in Private DB Zone)
  RedisSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 
        - "${ClusterName}-${Environment}-redis-sg-${ClusterIdShort}"
        - Environment: !If 
          - IsProduction
          - "prod"
          - !If 
            - IsStaging
            - "staging"
            - "dev"
      GroupDescription: Security group for ElastiCache Redis in Private DB Zone
      VpcId: !Ref VPC
      SecurityGroupIngress:
        # Allow Redis TLS access from Lambda Security Group (App subnets)
        - IpProtocol: tcp
          FromPort: 6380
          ToPort: 6380
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: Allow Redis TLS from Lambda Security Group (App subnets)
      Tags:
        - Key: Name
          Value: !Sub 
            - "${ClusterName}-${Environment}-redis-sg-${ClusterIdShort}"
            - Environment: !If 
              - IsProduction
              - "prod"
              - !If 
                - IsStaging
                - "staging"
                - "dev"
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateDB

  # Additional ingress rule for RDS to allow access from DB Proxy
  RDSSecurityGroupIngressFromDBProxy:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref RDSSecurityGroup
      IpProtocol: tcp
      FromPort: 3306
      ToPort: 3306
      SourceSecurityGroupId: !Ref DBProxySecurityGroup
      Description: Allow MySQL from DB Proxy Security Group

  # Egress rules for Lambda Security Group to access DB services
  LambdaSecurityGroupEgressRDS:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref LambdaSecurityGroup
      IpProtocol: tcp
      FromPort: 3306
      ToPort: 3306
      DestinationSecurityGroupId: !Ref RDSSecurityGroup
      Description: Allow MySQL to RDS Security Group

  LambdaSecurityGroupEgressDBProxy:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref LambdaSecurityGroup
      IpProtocol: tcp
      FromPort: 3306
      ToPort: 3306
      DestinationSecurityGroupId: !Ref DBProxySecurityGroup
      Description: Allow MySQL to DB Proxy Security Group

  LambdaSecurityGroupEgressRedis:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref LambdaSecurityGroup
      IpProtocol: tcp
      FromPort: 6380
      ToPort: 6380
      DestinationSecurityGroupId: !Ref RedisSecurityGroup
      Description: Allow Redis TLS to Redis Security Group

Outputs:
  # VPC Outputs
  VPC:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub ${EnvironmentName}-VPC

  VPCCidr:
    Description: VPC CIDR block
    Value: !GetAtt VPC.CidrBlock
    Export:
      Name: !Sub ${EnvironmentName}-VPC-CIDR

  # Private App Zone Subnet Outputs (for Lambda functions)
  PrivateAppSubnet1:
    Description: Private App Subnet in Availability Zone 1
    Value: !Ref PrivateAppSubnet1
    Export:
      Name: !Sub ${EnvironmentName}-PrivateAppSubnet1

  PrivateAppSubnet2:
    Description: Private App Subnet in Availability Zone 2
    Value: !Ref PrivateAppSubnet2
    Export:
      Name: !Sub ${EnvironmentName}-PrivateAppSubnet2

  PrivateAppSubnet3:
    Condition: UseAZ3
    Description: Private App Subnet in Availability Zone 3
    Value: !Ref PrivateAppSubnet3
    Export:
      Name: !Sub ${EnvironmentName}-PrivateAppSubnet3

  PrivateAppSubnets:
    Description: Comma-delimited list of Private App Subnet IDs
    Value: !If
      - UseAZ3
      - !Sub "${PrivateAppSubnet1},${PrivateAppSubnet2},${PrivateAppSubnet3}"
      - !Sub "${PrivateAppSubnet1},${PrivateAppSubnet2}"
    Export:
      Name: !Sub ${EnvironmentName}-PrivateAppSubnets

  # Private DB Zone Subnet Outputs (for Aurora MySQL)
  PrivateDBSubnet1:
    Description: Private DB Subnet in Availability Zone 1
    Value: !Ref PrivateDBSubnet1
    Export:
      Name: !Sub ${EnvironmentName}-PrivateDBSubnet1

  PrivateDBSubnet2:
    Description: Private DB Subnet in Availability Zone 2
    Value: !Ref PrivateDBSubnet2
    Export:
      Name: !Sub ${EnvironmentName}-PrivateDBSubnet2

  PrivateDBSubnet3:
    Condition: UseAZ3
    Description: Private DB Subnet in Availability Zone 3
    Value: !Ref PrivateDBSubnet3
    Export:
      Name: !Sub ${EnvironmentName}-PrivateDBSubnet3

  PrivateDBSubnets:
    Description: Comma-delimited list of Private DB Subnet IDs
    Value: !If
      - UseAZ3
      - !Sub "${PrivateDBSubnet1},${PrivateDBSubnet2},${PrivateDBSubnet3}"
      - !Sub "${PrivateDBSubnet1},${PrivateDBSubnet2}"
    Export:
      Name: !Sub ${EnvironmentName}-PrivateDBSubnets

  # Public Zone Subnet Outputs (for resources needing direct internet access)
  PublicSubnet1:
    Description: Public Subnet in Availability Zone 1
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub ${EnvironmentName}-PublicSubnet1

  PublicSubnet2:
    Description: Public Subnet in Availability Zone 2
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub ${EnvironmentName}-PublicSubnet2

  PublicSubnet3:
    Condition: UseAZ3
    Description: Public Subnet in Availability Zone 3
    Value: !Ref PublicSubnet3
    Export:
      Name: !Sub ${EnvironmentName}-PublicSubnet3

  PublicSubnets:
    Description: Comma-delimited list of Public Subnet IDs
    Value: !If
      - UseAZ3
      - !Sub "${PublicSubnet1},${PublicSubnet2},${PublicSubnet3}"
      - !Sub "${PublicSubnet1},${PublicSubnet2}"
    Export:
      Name: !Sub ${EnvironmentName}-PublicSubnets

  # Security Group Outputs
  LambdaSecurityGroup:
    Description: Lambda Security Group ID for Private App Zone
    Value: !Ref LambdaSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-LambdaSecurityGroup

  RDSSecurityGroup:
    Description: RDS Security Group ID for Aurora MySQL in Private DB Zone
    Value: !Ref RDSSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-RDSSecurityGroup

  DBProxySecurityGroup:
    Description: DB Proxy Security Group ID for RDS Proxy in Private DB Zone
    Value: !Ref DBProxySecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-DBProxySecurityGroup

  RedisSecurityGroup:
    Description: Redis Security Group ID for ElastiCache Redis in Private DB Zone
    Value: !Ref RedisSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-RedisSecurityGroup

  # Legacy DB Security Group output (for backward compatibility)
  DBSecurityGroup:
    Description: Legacy DB Security Group ID (use specific RDS/DBProxy/Redis security groups instead)
    Value: !Ref RDSSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-DBSecurityGroup

  # NAT Gateway Output
  NATGateway:
    Description: NAT Gateway ID for Lambda internet access
    Value: !Ref NATGateway
    Export:
      Name: !Sub ${EnvironmentName}-NATGateway

  # Route Table Outputs
  PrivateRouteTable:
    Description: Private Route Table ID (VPC internal routing only)
    Value: !Ref PrivateRouteTable
    Export:
      Name: !Sub ${EnvironmentName}-PrivateRouteTable

  NATRouteTable:
    Description: NAT Route Table ID (internet via NAT Gateway)
    Value: !Ref NATRouteTable
    Export:
      Name: !Sub ${EnvironmentName}-NATRouteTable

  PublicRouteTable:
    Description: Public Route Table ID (internet via IGW)
    Value: !Ref PublicRouteTable
    Export:
      Name: !Sub ${EnvironmentName}-PublicRouteTable

  # Template metadata
  TemplateVersion:
    Description: CloudFormation template version
    Value: "1.0.0"