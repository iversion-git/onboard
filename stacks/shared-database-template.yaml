AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Aurora MySQL Serverless v2 database infrastructure.
  Deploys Aurora MySQL cluster with RDS Proxy for connection pooling.
  Requires existing VPC infrastructure from infrastructure-template.yaml.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Environment Configuration"
        Parameters:
          - EnvironmentName
      - Label:
          default: "Database Configuration"
        Parameters:
          - DatabaseName
          - MinCapacity
          - MaxCapacity
          - BackupRetentionPeriod
          - PreferredBackupWindow
          - PreferredMaintenanceWindow
          - DeletionProtection
      - Label:
          default: "Resource Tagging"
        Parameters:
          - ProjectName
          - CostCenter
          - Owner
    ParameterLabels:
      EnvironmentName:
        default: "Environment Name"
      DatabaseName:
        default: "Default Database Name"
      MinCapacity:
        default: "Minimum Aurora Capacity Units"
      MaxCapacity:
        default: "Maximum Aurora Capacity Units"

Parameters:
  EnvironmentName:
    Type: String
    Description: Environment identifier (must match infrastructure stack)
    MinLength: 1
    MaxLength: 50
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9-]*$
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters and hyphens

  DatabaseName:
    Type: String
    Description: Default database name to create
    Default: appdb
    MinLength: 1
    MaxLength: 64
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9_]*$
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters and underscores

  MinCapacity:
    Type: Number
    Description: Minimum Aurora Capacity Units (ACU) for serverless v2
    Default: 0.5
    MinValue: 0.5
    MaxValue: 128
    ConstraintDescription: Must be between 0.5 and 128

  MaxCapacity:
    Type: Number
    Description: Maximum Aurora Capacity Units (ACU) for serverless v2
    Default: 128
    MinValue: 0.5
    MaxValue: 128
    ConstraintDescription: Must be between 0.5 and 128

  BackupRetentionPeriod:
    Type: Number
    Description: Number of days to retain automated backups
    Default: 7
    MinValue: 1
    MaxValue: 35
    ConstraintDescription: Must be between 1 and 35 days

  PreferredBackupWindow:
    Type: String
    Description: Preferred backup window (UTC time)
    Default: "03:00-04:00"
    AllowedPattern: ^([0-1][0-9]|2[0-3]):[0-5][0-9]-([0-1][0-9]|2[0-3]):[0-5][0-9]$
    ConstraintDescription: Must be in format HH:MM-HH:MM (UTC)

  PreferredMaintenanceWindow:
    Type: String
    Description: Preferred maintenance window
    Default: "sun:04:00-sun:05:00"
    AllowedPattern: ^(sun|mon|tue|wed|thu|fri|sat):[0-2][0-9]:[0-5][0-9]-(sun|mon|tue|wed|thu|fri|sat):[0-2][0-9]:[0-5][0-9]$
    ConstraintDescription: Must be in format ddd:HH:MM-ddd:HH:MM

  DeletionProtection:
    Type: String
    Description: Enable deletion protection for Aurora cluster
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
    ConstraintDescription: Must be true or false

  ProjectName:
    Type: String
    Description: Optional project name for resource tagging
    Default: ""
    MaxLength: 100

  CostCenter:
    Type: String
    Description: Optional cost center identifier for resource tagging
    Default: ""
    MaxLength: 100

  Owner:
    Type: String
    Description: Optional owner or team name for resource tagging
    Default: ""
    MaxLength: 100

  # Cluster-specific parameters for tagging (imported from infrastructure stack)
  ClusterName:
    Type: String
    Description: Name of the cluster for resource tagging
    MinLength: 1
    MaxLength: 255

  ClusterType:
    Type: String
    Description: Type of cluster (Shared or Dedicated) for resource tagging
    AllowedValues:
      - Shared
      - Dedicated
    ConstraintDescription: Must be either Shared or Dedicated

  ClusterEnvironment:
    Type: String
    Description: Environment of cluster (Production, Staging, or Dev) for resource tagging
    AllowedValues:
      - Production
      - Staging
      - Dev
    ConstraintDescription: Must be Production, Staging, or Dev

Conditions:
  # Conditions for optional custom tags
  HasProjectName: !Not [!Equals [!Ref ProjectName, '']]
  HasCostCenter: !Not [!Equals [!Ref CostCenter, '']]
  HasOwner: !Not [!Equals [!Ref Owner, '']]
  
  # Condition for deletion protection
  EnableDeletionProtection: !Equals [!Ref DeletionProtection, 'true']

Resources:
  # ==========================================
  # Security Groups for RDS Proxy and Aurora
  # ==========================================
  
  # RDS Proxy Security Group
  RDSProxySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvironmentName}-RDSProxySecurityGroup
      GroupDescription: Security group for RDS Proxy
      VpcId: !ImportValue
        'Fn::Sub': '${EnvironmentName}-VPC'
      SecurityGroupIngress:
        # Allow MySQL access from Lambda Security Group
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !ImportValue
            'Fn::Sub': '${EnvironmentName}-LambdaSecurityGroup'
          Description: Allow MySQL from Lambda Security Group
      SecurityGroupEgress:
        # Allow all outbound traffic
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-RDSProxySecurityGroup
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - !If
          - HasProjectName
          - Key: Project
            Value: !Ref ProjectName
          - !Ref AWS::NoValue
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  # Aurora MySQL Security Group
  AuroraSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvironmentName}-AuroraSecurityGroup
      GroupDescription: Security group for Aurora MySQL cluster
      VpcId: !ImportValue
        'Fn::Sub': '${EnvironmentName}-VPC'
      SecurityGroupIngress:
        # Allow MySQL access from RDS Proxy Security Group
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref RDSProxySecurityGroup
          Description: Allow MySQL from RDS Proxy Security Group
      SecurityGroupEgress:
        # Allow all outbound traffic
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-AuroraSecurityGroup
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - !If
          - HasProjectName
          - Key: Project
            Value: !Ref ProjectName
          - !Ref AWS::NoValue
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  # ==========================================
  # Aurora MySQL Serverless v2 Database
  # ==========================================
  
  # DB Subnet Group for Aurora (using imported subnets)
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    DeletionPolicy: Delete
    Properties:
      DBSubnetGroupName: !Sub ${EnvironmentName}-db-subnet-group
      DBSubnetGroupDescription: Subnet group for Aurora MySQL cluster
      SubnetIds: !Split
        - ','
        - !ImportValue
          'Fn::Sub': '${EnvironmentName}-PrivateDBSubnets'
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-db-subnet-group
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - !If
          - HasProjectName
          - Key: Project
            Value: !Ref ProjectName
          - !Ref AWS::NoValue
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  # Aurora MySQL Serverless v2 Cluster
  AuroraCluster:
    Type: AWS::RDS::DBCluster
    DeletionPolicy: Delete
    DependsOn:
      - DBSubnetGroup
    Properties:
      DBClusterIdentifier: !Sub ${EnvironmentName}-aurora-mysql
      Engine: aurora-mysql
      EngineMode: provisioned
      ServerlessV2ScalingConfiguration:
        MinCapacity: !Ref MinCapacity
        MaxCapacity: !Ref MaxCapacity
      MasterUsername: admin
      ManageMasterUserPassword: true
      DatabaseName: !Ref DatabaseName
      DBSubnetGroupName: !Ref DBSubnetGroup
      VpcSecurityGroupIds:
        - !Ref AuroraSecurityGroup
      BackupRetentionPeriod: !Ref BackupRetentionPeriod
      PreferredBackupWindow: !Ref PreferredBackupWindow
      PreferredMaintenanceWindow: !Ref PreferredMaintenanceWindow
      EnableCloudwatchLogsExports:
        - error
        - general
        - slowquery
      DeletionProtection: !If [EnableDeletionProtection, true, false]
      StorageEncrypted: true
      StorageType: aurora-iopt1
      CopyTagsToSnapshot: true
      EnableIAMDatabaseAuthentication: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-aurora-mysql
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - !If
          - HasProjectName
          - Key: Project
            Value: !Ref ProjectName
          - !Ref AWS::NoValue
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  # Aurora MySQL Writer Instance
  AuroraWriterInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Delete
    Properties:
      DBInstanceIdentifier: !Sub ${EnvironmentName}-aurora-writer
      DBClusterIdentifier: !Ref AuroraCluster
      DBInstanceClass: db.serverless
      Engine: aurora-mysql
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-aurora-writer
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - !If
          - HasProjectName
          - Key: Project
            Value: !Ref ProjectName
          - !Ref AWS::NoValue
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  # RDS Proxy for Connection Pooling
  DBProxyRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-rds-proxy-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: rds.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                Resource: 
                  - !GetAtt AuroraCluster.MasterUserSecret.SecretArn
                  - !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:rds-db-credentials/*'
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-rds-proxy-role
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - !If
          - HasProjectName
          - Key: Project
            Value: !Ref ProjectName
          - !Ref AWS::NoValue
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  DBProxy:
    Type: AWS::RDS::DBProxy
    DeletionPolicy: Delete
    DependsOn: 
      - AuroraCluster
    Properties:
      DBProxyName: !Sub ${EnvironmentName}-aurora-proxy
      EngineFamily: MYSQL
      Auth:
        - AuthScheme: SECRETS
          SecretArn: !GetAtt AuroraCluster.MasterUserSecret.SecretArn
      RoleArn: !GetAtt DBProxyRole.Arn
      VpcSubnetIds: !Split
        - ','
        - !ImportValue
          'Fn::Sub': '${EnvironmentName}-PrivateDBSubnets'
      VpcSecurityGroupIds:
        - !Ref RDSProxySecurityGroup
      RequireTLS: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-aurora-proxy
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - !If
          - HasProjectName
          - Key: Project
            Value: !Ref ProjectName
          - !Ref AWS::NoValue
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  DBProxyTargetGroup:
    Type: AWS::RDS::DBProxyTargetGroup
    DeletionPolicy: Delete
    DependsOn:
      - AuroraCluster
      - AuroraWriterInstance
      - DBProxy
    Properties:
      DBProxyName: !Ref DBProxy
      TargetGroupName: default
      DBClusterIdentifiers:
        - !Ref AuroraCluster

Outputs:
  # Database Outputs
  AuroraClusterEndpoint:
    Description: Aurora MySQL cluster endpoint
    Value: !GetAtt AuroraCluster.Endpoint.Address
    Export:
      Name: !Sub ${EnvironmentName}-AuroraClusterEndpoint

  AuroraClusterReadEndpoint:
    Description: Aurora MySQL cluster read endpoint
    Value: !GetAtt AuroraCluster.ReadEndpoint.Address
    Export:
      Name: !Sub ${EnvironmentName}-AuroraClusterReadEndpoint

  AuroraClusterPort:
    Description: Aurora MySQL cluster port
    Value: !GetAtt AuroraCluster.Endpoint.Port
    Export:
      Name: !Sub ${EnvironmentName}-AuroraClusterPort

  DBProxyEndpoint:
    Description: RDS Proxy endpoint for connection pooling
    Value: !GetAtt DBProxy.Endpoint
    Export:
      Name: !Sub ${EnvironmentName}-DBProxyEndpoint

  DBSecretArn:
    Description: ARN of the database password secret (AWS managed)
    Value: !GetAtt AuroraCluster.MasterUserSecret.SecretArn
    Export:
      Name: !Sub ${EnvironmentName}-DBSecretArn

  DatabaseName:
    Description: Default database name
    Value: !Ref DatabaseName
    Export:
      Name: !Sub ${EnvironmentName}-DatabaseName

  DBSubnetGroup:
    Description: DB Subnet Group name
    Value: !Ref DBSubnetGroup
    Export:
      Name: !Sub ${EnvironmentName}-DBSubnetGroup

  # Template metadata
  TemplateVersion:
    Description: CloudFormation template version
    Value: "1.0.0"