AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Shared cluster edge deployment stack - CloudFront distribution with WAF protection.
  Routes /api/* to API Gateway, serves Vue.js SPA from S3 (/portal/ and /dev-portal/).
  Includes WAF with best practices for PHP/Vue.js applications.

Parameters:
  EnvironmentName:
    Type: String
    Description: Environment identifier (must match other stacks)
    MinLength: 1
    MaxLength: 50
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9-]*$
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters and hyphens

  # Frontend assets bucket name (will be created by this stack)
  FrontendBucketName:
    Type: String
    Description: S3 bucket name for frontend assets (will be created if it doesn't exist)
    Default: ""
    MaxLength: 255

  # API Gateway endpoint (imported from app stack)
  ApiGatewayDomainName:
    Type: String
    Description: API Gateway domain name (without https://)
    MinLength: 1
    ConstraintDescription: Must specify the API Gateway domain name

  # Custom domain configuration for multi-tenant setup
  CustomDomainName:
    Type: String
    Description: Custom domain name for CloudFront (e.g., tenant.flowrix.app)
    Default: "*.flowrix.app"
    MaxLength: 255

  CertificateArn:
    Type: String
    Description: ACM certificate ARN for wildcard domain (*.flowrix.app)
    Default: "arn:aws:acm:us-east-1:078607863013:certificate/d0097bd1-e417-4057-9747-24b0d81885f8"
    MinLength: 1
    ConstraintDescription: Must provide ACM certificate ARN for *.flowrix.app

  ProjectName:
    Type: String
    Description: Optional project name for resource tagging
    Default: ""
    MaxLength: 100

  CostCenter:
    Type: String
    Description: Optional cost center identifier for resource tagging
    Default: ""
    MaxLength: 100

  Owner:
    Type: String
    Description: Optional owner or team name for resource tagging
    Default: ""
    MaxLength: 100

  # Cluster-specific parameters for tagging
  ClusterName:
    Type: String
    Description: Name of the cluster for resource tagging
    MinLength: 1
    MaxLength: 255

  ClusterType:
    Type: String
    Description: Type of cluster (Shared or Dedicated) for resource tagging
    AllowedValues:
      - Shared
      - Dedicated
    ConstraintDescription: Must be either Shared or Dedicated

  ClusterEnvironment:
    Type: String
    Description: Environment of cluster (Production, Staging, or Dev) for resource tagging
    AllowedValues:
      - Production
      - Staging
      - Dev
    ConstraintDescription: Must be Production, Staging, or Dev

Conditions:
  # Conditions for optional custom tags
  HasProjectName: !Not [!Equals [!Ref ProjectName, '']]
  HasCostCenter: !Not [!Equals [!Ref CostCenter, '']]
  HasOwner: !Not [!Equals [!Ref Owner, '']]
  
  # Condition for custom domain (always true now since we have defaults)
  HasCustomDomain: !Not [!Equals [!Ref CustomDomainName, '']]
  
  # Condition for wildcard domain
  IsWildcardDomain: !Equals [!Ref CustomDomainName, '*.flowrix.app']
  
  # Condition for custom frontend bucket name
  HasCustomFrontendBucket: !Not [!Equals [!Ref FrontendBucketName, '']]

Resources:
  # ==========================================
  # Dedicated S3 Bucket for Frontend Assets
  # ==========================================
  
  FrontendAssetsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !If
        - HasCustomFrontendBucket
        - !Ref FrontendBucketName
        - !Sub "${EnvironmentName}-frontend-assets-${AWS::AccountId}-${AWS::Region}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        RestrictPublicBuckets: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
      VersioningConfiguration:
        Status: Enabled
      NotificationConfiguration:
        CloudWatchConfigurations:
          - Event: s3:ObjectCreated:*
            CloudWatchConfiguration:
              LogGroupName: !Ref FrontendBucketLogGroup
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-frontend-assets
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: Purpose
          Value: Frontend Assets (Vue.js SPA)
        - Key: ManagedBy
          Value: CloudFormation
        - !If
          - HasProjectName
          - Key: Project
            Value: !Ref ProjectName
          - !Ref AWS::NoValue
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  # CloudWatch Log Group for S3 bucket notifications
  FrontendBucketLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/s3/${EnvironmentName}-frontend-assets
      RetentionInDays: 30
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-frontend-bucket-logs
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation

  # ==========================================
  # AWS WAF v2 Web ACL for CloudFront
  # ==========================================
  
  WebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: !Sub ${EnvironmentName}-edge-waf
      Description: WAF for CloudFront distribution with PHP/Vue.js best practices
      Scope: CLOUDFRONT
      DefaultAction:
        Allow: {}
      Rules:
        # AWS Managed Rule - Core Rule Set (OWASP Top 10)
        - Name: AWSManagedRulesCommonRuleSet
          Priority: 1
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesCommonRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: CommonRuleSetMetric
        
        # AWS Managed Rule - Known Bad Inputs
        - Name: AWSManagedRulesKnownBadInputsRuleSet
          Priority: 2
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesKnownBadInputsRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: KnownBadInputsMetric
        
        # AWS Managed Rule - PHP Application Protection
        - Name: AWSManagedRulesPHPRuleSet
          Priority: 3
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesPHPRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: PHPRuleSetMetric
        
        # AWS Managed Rule - IP Reputation
        - Name: AWSManagedRulesAmazonIpReputationList
          Priority: 4
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesAmazonIpReputationList
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: IpReputationMetric
        
        # Block direct API Gateway access (only allow through CloudFront)
        - Name: BlockDirectApiAccess
          Priority: 5
          Action:
            Block: {}
          Statement:
            AndStatement:
              Statements:
                - ByteMatchStatement:
                    SearchString: !Ref ApiGatewayDomainName
                    FieldToMatch:
                      SingleHeader:
                        Name: host
                    TextTransformations:
                      - Priority: 0
                        Type: LOWERCASE
                    PositionalConstraint: EXACTLY
                - NotStatement:
                    Statement:
                      ByteMatchStatement:
                        SearchString: !Sub ${EnvironmentName}-cloudfront
                        FieldToMatch:
                          SingleHeader:
                            Name: x-forwarded-for
                        TextTransformations:
                          - Priority: 0
                            Type: LOWERCASE
                        PositionalConstraint: CONTAINS
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: BlockDirectApiAccessMetric
        
        # Basic rate limiting (will be customized later)
        - Name: RateLimitRule
          Priority: 6
          Action:
            Block: {}
          Statement:
            RateBasedStatement:
              Limit: 2000
              AggregateKeyType: IP
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: RateLimitMetric
      
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: !Sub ${EnvironmentName}-edge-waf
      
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-edge-waf
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - !If
          - HasProjectName
          - Key: Project
            Value: !Ref ProjectName
          - !Ref AWS::NoValue
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  # ==========================================
  # CloudFront Origin Access Control for S3
  # ==========================================
  
  OriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub ${EnvironmentName}-s3-oac
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4
        Description: Origin Access Control for S3 bucket

  # ==========================================
  # CloudFront Distribution
  # ==========================================
  
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Comment: !Sub ${EnvironmentName} Edge Distribution - Vue.js SPA + API Gateway
        Enabled: true
        HttpVersion: http2
        PriceClass: PriceClass_100
        WebACLId: !GetAtt WebACL.Arn
        
        # Custom domain configuration (wildcard support)
        Aliases: !If
          - IsWildcardDomain
          - !Ref AWS::NoValue  # Don't set aliases for wildcard, handle via Route53
          - !If
            - HasCustomDomain
            - [!Ref CustomDomainName]
            - !Ref AWS::NoValue
        
        ViewerCertificate: !If
          - HasCustomDomain
          - AcmCertificateArn: !Ref CertificateArn
            SslSupportMethod: sni-only
            MinimumProtocolVersion: TLSv1.2_2021
          - CloudFrontDefaultCertificate: true
        
        # Origins
        Origins:
          # S3 Origin for Vue.js frontend assets (dedicated bucket)
          - Id: S3Origin
            DomainName: !GetAtt FrontendAssetsBucket.RegionalDomainName
            OriginAccessControlId: !Ref OriginAccessControl
            S3OriginConfig:
              OriginAccessIdentity: ""
          
          # API Gateway Origin for /api/* routes
          - Id: ApiGatewayOrigin
            DomainName: !Ref ApiGatewayDomainName
            CustomOriginConfig:
              HTTPPort: 443
              HTTPSPort: 443
              OriginProtocolPolicy: https-only
              OriginSSLProtocols:
                - TLSv1.2
            OriginCustomHeaders:
              - HeaderName: x-forwarded-for
                HeaderValue: !Sub ${EnvironmentName}-cloudfront
        
        # Cache Behaviors
        CacheBehaviors:
          # API routes - no caching, forward all headers
          - PathPattern: "/api/*"
            TargetOriginId: ApiGatewayOrigin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - DELETE
              - GET
              - HEAD
              - OPTIONS
              - PATCH
              - POST
              - PUT
            CachedMethods:
              - GET
              - HEAD
            CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad  # CachingDisabled
            OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf  # CORS-S3Origin
            ResponseHeadersPolicyId: 67f7725c-6f97-4210-82d7-5512b31e9d03  # SecurityHeadersPolicy
            Compress: true
          
          # Dev portal - Vue.js SPA
          - PathPattern: "/dev-portal/*"
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
            CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # CachingOptimized
            OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf  # CORS-S3Origin
            ResponseHeadersPolicyId: 67f7725c-6f97-4210-82d7-5512b31e9d03  # SecurityHeadersPolicy
            Compress: true
            # Rewrite path to remove /dev-portal prefix
            FunctionAssociations:
              - EventType: viewer-request
                FunctionARN: !GetAtt DevPortalRewriteFunction.FunctionMetadata.FunctionARN
        
        # Default behavior - Production portal (Vue.js SPA)
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # CachingOptimized
          OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf  # CORS-S3Origin
          ResponseHeadersPolicyId: 67f7725c-6f97-4210-82d7-5512b31e9d03  # SecurityHeadersPolicy
          Compress: true
          # Rewrite path to add /portal prefix
          FunctionAssociations:
            - EventType: viewer-request
              FunctionARN: !GetAtt PortalRewriteFunction.FunctionMetadata.FunctionARN
        
        # Custom error pages for SPA routing
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /portal/index.html
            ErrorCachingMinTTL: 300
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /portal/index.html
            ErrorCachingMinTTL: 300
      
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-cloudfront
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - !If
          - HasProjectName
          - Key: Project
            Value: !Ref ProjectName
          - !Ref AWS::NoValue
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  # ==========================================
  # CloudFront Functions for Path Rewriting
  # ==========================================
  
  # Function to rewrite root requests to /portal/
  PortalRewriteFunction:
    Type: AWS::CloudFront::Function
    Properties:
      Name: !Sub ${EnvironmentName}-portal-rewrite
      FunctionConfig:
        Comment: Rewrite requests to add /portal/ prefix for production SPA
        Runtime: cloudfront-js-1.0
      FunctionCode: |
        function handler(event) {
          var request = event.request;
          var uri = request.uri;
          
          // If requesting root or no extension, serve from /portal/
          if (uri === '/' || uri === '') {
            request.uri = '/portal/index.html';
          } else if (!uri.includes('.') && !uri.startsWith('/portal/')) {
            // SPA routing - serve index.html for routes without extensions
            request.uri = '/portal/index.html';
          } else if (!uri.startsWith('/portal/') && !uri.startsWith('/api/') && !uri.startsWith('/dev-portal/')) {
            // Add /portal/ prefix to asset requests
            request.uri = '/portal' + uri;
          }
          
          return request;
        }
  
  # Function to rewrite /dev-portal/ requests
  DevPortalRewriteFunction:
    Type: AWS::CloudFront::Function
    Properties:
      Name: !Sub ${EnvironmentName}-dev-portal-rewrite
      FunctionConfig:
        Comment: Rewrite /dev-portal/ requests to serve from S3 dev-portal folder
        Runtime: cloudfront-js-1.0
      FunctionCode: |
        function handler(event) {
          var request = event.request;
          var uri = request.uri;
          
          // Remove /dev-portal prefix and handle SPA routing
          if (uri === '/dev-portal' || uri === '/dev-portal/') {
            request.uri = '/dev-portal/index.html';
          } else if (uri.startsWith('/dev-portal/')) {
            var newUri = uri.substring(11); // Remove '/dev-portal'
            if (!newUri.includes('.')) {
              // SPA routing - serve index.html for routes without extensions
              request.uri = '/dev-portal/index.html';
            } else {
              // Keep the dev-portal prefix for assets
              request.uri = uri;
            }
          }
          
          return request;
        }

  # ==========================================
  # S3 Bucket Policy for CloudFront OAC
  # ==========================================
  
  S3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendAssetsBucket
      PolicyDocument:
        Statement:
          - Sid: AllowCloudFrontServicePrincipal
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub ${FrontendAssetsBucket.Arn}/*
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}

Outputs:
  # S3 Frontend Bucket Outputs
  FrontendAssetsBucketName:
    Description: S3 bucket name for frontend assets
    Value: !Ref FrontendAssetsBucket
    Export:
      Name: !Sub ${EnvironmentName}-FrontendAssetsBucketName

  FrontendAssetsBucketArn:
    Description: S3 bucket ARN for frontend assets
    Value: !GetAtt FrontendAssetsBucket.Arn
    Export:
      Name: !Sub ${EnvironmentName}-FrontendAssetsBucketArn

  FrontendAssetsBucketDomainName:
    Description: S3 bucket regional domain name
    Value: !GetAtt FrontendAssetsBucket.RegionalDomainName
    Export:
      Name: !Sub ${EnvironmentName}-FrontendAssetsBucketDomainName

  # CloudFront Outputs
  CloudFrontDistributionId:
    Description: CloudFront distribution ID
    Value: !Ref CloudFrontDistribution
    Export:
      Name: !Sub ${EnvironmentName}-CloudFrontDistributionId

  CloudFrontDomainName:
    Description: CloudFront distribution domain name
    Value: !GetAtt CloudFrontDistribution.DomainName
    Export:
      Name: !Sub ${EnvironmentName}-CloudFrontDomainName

  CloudFrontDistributionArn:
    Description: CloudFront distribution ARN
    Value: !Sub arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}
    Export:
      Name: !Sub ${EnvironmentName}-CloudFrontDistributionArn

  # WAF Outputs
  WebACLId:
    Description: WAF Web ACL ID
    Value: !Ref WebACL
    Export:
      Name: !Sub ${EnvironmentName}-WebACLId

  WebACLArn:
    Description: WAF Web ACL ARN
    Value: !GetAtt WebACL.Arn
    Export:
      Name: !Sub ${EnvironmentName}-WebACLArn

  # Access URLs (multi-tenant aware)
  ProductionPortalUrl:
    Description: Production portal URL (use tenant.flowrix.app for specific tenant)
    Value: !If
      - IsWildcardDomain
      - "https://[tenant].flowrix.app/"
      - !If
        - HasCustomDomain
        - !Sub https://${CustomDomainName}/
        - !Sub https://${CloudFrontDistribution.DomainName}/
    Export:
      Name: !Sub ${EnvironmentName}-ProductionPortalUrl

  DevPortalUrl:
    Description: Development portal URL (use tenant.flowrix.app/dev-portal/ for specific tenant)
    Value: !If
      - IsWildcardDomain
      - "https://[tenant].flowrix.app/dev-portal/"
      - !If
        - HasCustomDomain
        - !Sub https://${CustomDomainName}/dev-portal/
        - !Sub https://${CloudFrontDistribution.DomainName}/dev-portal/
    Export:
      Name: !Sub ${EnvironmentName}-DevPortalUrl

  ApiUrl:
    Description: API URL through CloudFront (use tenant.flowrix.app/api/ for specific tenant)
    Value: !If
      - IsWildcardDomain
      - "https://[tenant].flowrix.app/api/"
      - !If
        - HasCustomDomain
        - !Sub https://${CustomDomainName}/api/
        - !Sub https://${CloudFrontDistribution.DomainName}/api/
    Export:
      Name: !Sub ${EnvironmentName}-EdgeApiUrl

  # Multi-tenant configuration info
  WildcardDomainPattern:
    Description: Wildcard domain pattern for multi-tenant setup
    Value: "*.flowrix.app"
    Export:
      Name: !Sub ${EnvironmentName}-WildcardDomainPattern

  CertificateArnUsed:
    Description: ACM certificate ARN used for SSL
    Value: !Ref CertificateArn
    Export:
      Name: !Sub ${EnvironmentName}-CertificateArn

  # Template metadata
  TemplateVersion:
    Description: CloudFormation template version
    Value: "1.0.0"

  DeploymentArchitecture:
    Description: Edge deployment architecture
    Value: "CloudFront + WAF + S3 (Vue.js SPA) + API Gateway"