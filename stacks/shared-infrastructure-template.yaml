AWSTemplateFormatVersion: '2010-09-09'
Description: >
  VPC infrastructure for serverless applications.
  Creates a two-zone architecture (Private App, Private DB) with NAT Gateway
  for Lambda functions running in VPC with private database access.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Environment Configuration"
        Parameters:
          - EnvironmentName
      - Label:
          default: "Network Configuration"
        Parameters:
          - VpcCIDR
          - AvailabilityZoneCount
      - Label:
          default: "Private App Zone Subnets"
        Parameters:
          - PrivateAppSubnet1CIDR
          - PrivateAppSubnet2CIDR
          - PrivateAppSubnet3CIDR
      - Label:
          default: "Private DB Zone Subnets"
        Parameters:
          - PrivateDBSubnet1CIDR
          - PrivateDBSubnet2CIDR
          - PrivateDBSubnet3CIDR
      - Label:
          default: "Resource Tagging"
        Parameters:
          - ProjectName
          - CostCenter
          - Owner
    ParameterLabels:
      EnvironmentName:
        default: "Environment Name"
      VpcCIDR:
        default: "VPC CIDR Block"
      AvailabilityZoneCount:
        default: "Number of Availability Zones"

Parameters:
  EnvironmentName:
    Type: String
    Description: Environment identifier (e.g., prod, staging, dev)
    MinLength: 1
    MaxLength: 50
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9-]*$
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters and hyphens

  VpcCIDR:
    Type: String
    Description: CIDR block for the VPC
    Default: 10.0.0.0/16
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  AvailabilityZoneCount:
    Type: Number
    Description: Number of Availability Zones to use (2 or 3)
    Default: 2
    AllowedValues:
      - 2
      - 3
    ConstraintDescription: Must be 2 or 3

  PrivateAppSubnet1CIDR:
    Type: String
    Description: CIDR block for Private App Subnet in Availability Zone 1
    Default: 10.0.1.0/24
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  PrivateAppSubnet2CIDR:
    Type: String
    Description: CIDR block for Private App Subnet in Availability Zone 2
    Default: 10.0.2.0/24
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  PrivateAppSubnet3CIDR:
    Type: String
    Description: CIDR block for Private App Subnet in Availability Zone 3
    Default: 10.0.3.0/24
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  PrivateDBSubnet1CIDR:
    Type: String
    Description: CIDR block for Private DB Subnet in Availability Zone 1
    Default: 10.0.11.0/24
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  PrivateDBSubnet2CIDR:
    Type: String
    Description: CIDR block for Private DB Subnet in Availability Zone 2
    Default: 10.0.12.0/24
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  PrivateDBSubnet3CIDR:
    Type: String
    Description: CIDR block for Private DB Subnet in Availability Zone 3
    Default: 10.0.13.0/24
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block in the format x.x.x.x/x

  ProjectName:
    Type: String
    Description: Optional project name for resource tagging
    Default: ""
    MaxLength: 100

  CostCenter:
    Type: String
    Description: Optional cost center identifier for resource tagging
    Default: ""
    MaxLength: 100

  Owner:
    Type: String
    Description: Optional owner or team name for resource tagging
    Default: ""
    MaxLength: 100

  # Cluster-specific parameters for tagging
  ClusterName:
    Type: String
    Description: Name of the cluster for resource tagging
    MinLength: 1
    MaxLength: 255

  ClusterType:
    Type: String
    Description: Type of cluster (Shared or Dedicated) for resource tagging
    AllowedValues:
      - Shared
      - Dedicated
    ConstraintDescription: Must be either Shared or Dedicated

  ClusterEnvironment:
    Type: String
    Description: Environment of cluster (Production, Staging, or Dev) for resource tagging
    AllowedValues:
      - Production
      - Staging
      - Dev
    ConstraintDescription: Must be Production, Staging, or Dev

Conditions:
  # Condition to determine if we should use Availability Zone 3
  UseAZ3: !Equals [!Ref AvailabilityZoneCount, 3]
  
  # Conditions for optional custom tags
  HasProjectName: !Not [!Equals [!Ref ProjectName, '']]
  HasCostCenter: !Not [!Equals [!Ref CostCenter, '']]
  HasOwner: !Not [!Equals [!Ref Owner, '']]

Resources:
  # ==========================================
  # VPC and Core Networking
  # ==========================================
  
  VPC:
    Type: AWS::EC2::VPC
    DeletionPolicy: Delete
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Ref ClusterName
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - !If
          - HasProjectName
          - Key: Project
            Value: !Ref ProjectName
          - !Ref AWS::NoValue
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  # ==========================================
  # Internet Gateway (for NAT Gateway only)
  # ==========================================
  
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-InternetGateway
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # ==========================================
  # Private App Zone Subnets (for Lambda functions)
  # ==========================================
  
  PrivateAppSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateAppSubnet1CIDR
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateAppSubnet-AZ1
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateApp

  PrivateAppSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateAppSubnet2CIDR
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateAppSubnet-AZ2
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateApp

  PrivateAppSubnet3:
    Type: AWS::EC2::Subnet
    Condition: UseAZ3
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateAppSubnet3CIDR
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateAppSubnet-AZ3
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateApp

  # ==========================================
  # Private DB Zone Subnets (for Aurora MySQL)
  # ==========================================
  
  PrivateDBSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateDBSubnet1CIDR
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateDBSubnet-AZ1
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateDB

  PrivateDBSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateDBSubnet2CIDR
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateDBSubnet-AZ2
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateDB

  PrivateDBSubnet3:
    Type: AWS::EC2::Subnet
    Condition: UseAZ3
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateDBSubnet3CIDR
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateDBSubnet-AZ3
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateDB

  # ==========================================
  # NAT Gateway Infrastructure (for Lambda internet access)
  # ==========================================
  
  # Elastic IP for NAT Gateway
  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-NATGatewayEIP
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation

  # NAT Gateway (placed in first App subnet for simplicity)
  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PrivateAppSubnet1
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-NATGateway
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation

  # ==========================================
  # Route Tables
  # ==========================================
  
  # Route table for Private App Zone (with NAT Gateway route)
  PrivateAppRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateAppRouteTable
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateApp

  # Route to NAT Gateway for internet access
  PrivateAppRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateAppRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  # Route table for Private DB Zone (no internet access)
  PrivateDBRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-PrivateDBRouteTable
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateDB

  # ==========================================
  # Subnet Route Table Associations
  # ==========================================
  
  # Associate App subnets with App route table (NAT Gateway access)
  PrivateAppSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateAppSubnet1
      RouteTableId: !Ref PrivateAppRouteTable

  PrivateAppSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateAppSubnet2
      RouteTableId: !Ref PrivateAppRouteTable

  PrivateAppSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseAZ3
    Properties:
      SubnetId: !Ref PrivateAppSubnet3
      RouteTableId: !Ref PrivateAppRouteTable

  # Associate DB subnets with DB route table (no internet access)
  PrivateDBSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateDBSubnet1
      RouteTableId: !Ref PrivateDBRouteTable

  PrivateDBSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateDBSubnet2
      RouteTableId: !Ref PrivateDBRouteTable

  PrivateDBSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseAZ3
    Properties:
      SubnetId: !Ref PrivateDBSubnet3
      RouteTableId: !Ref PrivateDBRouteTable

  # ==========================================
  # Security Groups
  # ==========================================
  
  # Lambda Security Group (for functions in Private App Zone)
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvironmentName}-LambdaSecurityGroup
      GroupDescription: Security group for Lambda functions in Private App Zone
      VpcId: !Ref VPC
      SecurityGroupEgress:
        # Allow HTTPS traffic to internet (for API calls, package downloads)
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: Allow HTTPS to internet
        # Allow HTTP traffic to internet (for package downloads)
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: Allow HTTP to internet
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-LambdaSecurityGroup
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateApp

  # DB Security Group (for Aurora MySQL, RDS Proxy, Redis, Vault in Private DB Zone)
  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvironmentName}-DBSecurityGroup
      GroupDescription: Security group for database resources (Aurora MySQL, RDS Proxy, Redis, Vault) in Private DB Zone
      VpcId: !Ref VPC
      SecurityGroupIngress:
        # Allow MySQL access from Lambda Security Group (Aurora MySQL direct)
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: Allow MySQL from Lambda Security Group
        # Allow RDS Proxy access from Lambda Security Group (RDS Proxy)
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: Allow RDS Proxy from Lambda Security Group
        # Allow Redis access from Lambda Security Group (ElastiCache Redis)
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: Allow Redis from Lambda Security Group
        # Allow Vault access from Lambda Security Group (HashiCorp Vault)
        - IpProtocol: tcp
          FromPort: 8200
          ToPort: 8200
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: Allow Vault from Lambda Security Group
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-DBSecurityGroup
        - Key: Type
          Value: !Ref ClusterType
        - Key: Environment
          Value: !Ref ClusterEnvironment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Zone
          Value: PrivateDB

  # Egress rules for Lambda Security Group to access DB services
  LambdaSecurityGroupEgressMySQL:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref LambdaSecurityGroup
      IpProtocol: tcp
      FromPort: 3306
      ToPort: 3306
      DestinationSecurityGroupId: !Ref DBSecurityGroup
      Description: Allow MySQL to DB Security Group

  LambdaSecurityGroupEgressRedis:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref LambdaSecurityGroup
      IpProtocol: tcp
      FromPort: 6379
      ToPort: 6379
      DestinationSecurityGroupId: !Ref DBSecurityGroup
      Description: Allow Redis to DB Security Group

  LambdaSecurityGroupEgressVault:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref LambdaSecurityGroup
      IpProtocol: tcp
      FromPort: 8200
      ToPort: 8200
      DestinationSecurityGroupId: !Ref DBSecurityGroup
      Description: Allow Vault to DB Security Group

Outputs:
  # VPC Outputs
  VPC:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub ${EnvironmentName}-VPC

  VPCCidr:
    Description: VPC CIDR block
    Value: !GetAtt VPC.CidrBlock
    Export:
      Name: !Sub ${EnvironmentName}-VPC-CIDR

  # Private App Zone Subnet Outputs (for Lambda functions)
  PrivateAppSubnet1:
    Description: Private App Subnet in Availability Zone 1
    Value: !Ref PrivateAppSubnet1
    Export:
      Name: !Sub ${EnvironmentName}-PrivateAppSubnet1

  PrivateAppSubnet2:
    Description: Private App Subnet in Availability Zone 2
    Value: !Ref PrivateAppSubnet2
    Export:
      Name: !Sub ${EnvironmentName}-PrivateAppSubnet2

  PrivateAppSubnet3:
    Condition: UseAZ3
    Description: Private App Subnet in Availability Zone 3
    Value: !Ref PrivateAppSubnet3
    Export:
      Name: !Sub ${EnvironmentName}-PrivateAppSubnet3

  PrivateAppSubnets:
    Description: Comma-delimited list of Private App Subnet IDs
    Value: !If
      - UseAZ3
      - !Sub "${PrivateAppSubnet1},${PrivateAppSubnet2},${PrivateAppSubnet3}"
      - !Sub "${PrivateAppSubnet1},${PrivateAppSubnet2}"
    Export:
      Name: !Sub ${EnvironmentName}-PrivateAppSubnets

  # Private DB Zone Subnet Outputs (for Aurora MySQL)
  PrivateDBSubnet1:
    Description: Private DB Subnet in Availability Zone 1
    Value: !Ref PrivateDBSubnet1
    Export:
      Name: !Sub ${EnvironmentName}-PrivateDBSubnet1

  PrivateDBSubnet2:
    Description: Private DB Subnet in Availability Zone 2
    Value: !Ref PrivateDBSubnet2
    Export:
      Name: !Sub ${EnvironmentName}-PrivateDBSubnet2

  PrivateDBSubnet3:
    Condition: UseAZ3
    Description: Private DB Subnet in Availability Zone 3
    Value: !Ref PrivateDBSubnet3
    Export:
      Name: !Sub ${EnvironmentName}-PrivateDBSubnet3

  PrivateDBSubnets:
    Description: Comma-delimited list of Private DB Subnet IDs
    Value: !If
      - UseAZ3
      - !Sub "${PrivateDBSubnet1},${PrivateDBSubnet2},${PrivateDBSubnet3}"
      - !Sub "${PrivateDBSubnet1},${PrivateDBSubnet2}"
    Export:
      Name: !Sub ${EnvironmentName}-PrivateDBSubnets

  # Security Group Outputs
  LambdaSecurityGroup:
    Description: Lambda Security Group ID for Private App Zone
    Value: !Ref LambdaSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-LambdaSecurityGroup

  DBSecurityGroup:
    Description: DB Security Group ID for Private DB Zone
    Value: !Ref DBSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-DBSecurityGroup

  # NAT Gateway Output
  NATGateway:
    Description: NAT Gateway ID for Lambda internet access
    Value: !Ref NATGateway
    Export:
      Name: !Sub ${EnvironmentName}-NATGateway

  # Template metadata
  TemplateVersion:
    Description: CloudFormation template version
    Value: "1.0.0"